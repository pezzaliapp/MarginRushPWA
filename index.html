<!doctype html>
<html lang="it">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Margin Rush — mini fix</title>
<style>
  body{margin:0;background:#0b1220;color:#eaf0ff;font:16px/1.5 system-ui,-apple-system,Segoe UI,Roboto,Arial}
  header{position:sticky;top:0;padding:10px;background:#0f1930;border-bottom:1px solid #1f2d4f}
  .wrap{max-width:1000px;margin:0 auto;padding:10px}
  .pill{display:inline-block;padding:2px 8px;border:1px solid #1f2d4f;border-radius:999px;background:#132046;color:#b9c7eb}
  button{background:#87a7ff;color:#0a1025;border:0;border-radius:10px;padding:8px 12px;font-weight:700;cursor:pointer}
  table{width:100%;border-collapse:collapse;margin-top:10px;background:#0f1930;border:1px solid #1f2d4f;border-radius:12px;overflow:hidden}
  th,td{padding:8px;border-bottom:1px solid #1f2d4f;text-align:right}
  th:first-child,td:first-child{text-align:left}
  .grid{display:grid;grid-template-columns:1fr 1fr;gap:12px;margin-top:12px}
  .card{background:#0f1930;border:1px solid #1f2d4f;border-radius:12px;padding:10px}
  .muted{color:#b9c7eb}
  @media(max-width:800px){.grid{grid-template-columns:1fr}}
</style>
</head>
<body>
<header class="wrap">
  <h1 style="margin:0">Margin Rush <span class="pill">fix minimale</span></h1>
  <div class="muted">Mostra SEMPRE Noi + 3 competitor e domanda logit. Niente dipendenze, niente truncation.</div>
</header>

<main class="wrap">
  <div class="grid">
    <div class="card">
      <div class="muted">Mercato: M=<span id="M">1200</span> clienti/g — β=<span id="betaEcho">0.08</span> — Stag=<span id="seasonEcho">0%</span></div>
      <table>
        <thead><tr><th>Offerta</th><th>Prezzo</th><th>Q</th><th>B</th><th>S</th><th>Quota</th><th>Unità</th></tr></thead>
        <tbody id="rows"></tbody>
      </table>
    </div>
    <div class="card">
      <div>Prezzo nostro: <input id="price" type="range" min="5" max="120" step="0.5" value="49"> <b id="priceEcho">49.00</b> €</div>
      <div style="margin-top:6px">β: <input id="beta" type="number" step="0.005" value="0.08" style="width:80px"> — Stag %: <input id="season" type="number" value="0" style="width:70px"></div>
      <div style="margin-top:10px"><button id="next">Avanza giorno</button> <span class="muted">Giorno <b id="day">1</b>/10</span></div>
      <div class="muted" style="margin-top:8px">Utile netto giorno: <b id="profit">€0,00</b> — Quota nostra: <b id="share">0%</b></div>
    </div>
  </div>
</main>

<script>
  // ---- stato base
  const euro=n=>(Math.round(n*100)/100).toLocaleString('it-IT',{style:'currency',currency:'EUR'});
  const clamp=(x,a,b)=>Math.max(a,Math.min(b,x));
  let day=1, M=1200, beta=0.08, season=0, iva=false, ivaPct=0.22;
  const me ={name:"Noi", p:49, Q:1, B:1, S:1};
  const A  ={name:"Comp A (Price-war)", p:45, Q:1, B:1, S:1, strat:"price"};
  const Bc ={name:"Comp B (Premium)",   p:70, Q:2, B:2, S:2, strat:"premium"};
  const C  ={name:"Comp C (Bandit)",    p:52, Q:1, B:1, S:1, strat:"bandit", eps:0.25, Qvals:[0,0,0,0,0], N:[0,0,0,0,0]};
  const actions=[ // per C
    {dp:-0.10,dQ:0,dB:0,dS:0, name:"Price -10%"},
    {dp:-0.05,dQ:0,dB:0,dS:0, name:"Price -5%"},
    {dp:0,    dQ:0,dB:1,dS:0, name:"+Brand"},
    {dp:0,    dQ:1,dB:0,dS:0, name:"+Quality"},
    {dp:+0.05,dQ:0,dB:0,dS:1, name:"+Service & +5%"}
  ];
  const rowsEl=document.getElementById('rows');

  // ---- modello logit
  function util(o){
    const base=0.6+(o.B-1)*0.15+(o.Q-1)*0.2;
    const price=-beta*o.p;
    const q=0.25*(o.Q-1), b=0.20*(o.B-1), s=0.15*(o.S-1);
    const shock=(season/100)*(0.1+0.2*(o.B-1));
    return base+price+q+b+s+shock;
  }
  function shares(arr){
    const U=arr.map(util), mx=Math.max(...U), exps=U.map(u=>Math.exp(u-mx));
    const sum=exps.reduce((a,b)=>a+b,0); return exps.map(e=>e/sum);
  }
  const netP = p => iva ? p/(1+ivaPct) : p;
  const costU = Q => 8+2*Q;

  // ---- render tabella
  function render(){
    document.getElementById('priceEcho').textContent=parseFloat(me.p).toFixed(2);
    document.getElementById('betaEcho').textContent=beta.toFixed(3);
    document.getElementById('seasonEcho').textContent=(season>=0?'+':'')+season+'%';
    const players=[me,A,Bc,C];
    const s=shares(players);
    const market=Math.round(M*(1+season/100));
    const q=s.map(x=>Math.round(x*market));
    const names=players.map(p=>p.name);
    const html=players.map((p,i)=>`
      <tr><td>${names[i]}</td><td>${euro(p.p)}</td><td>${p.Q}</td><td>${p.B}</td><td>${p.S}</td>
      <td>${(s[i]*100).toFixed(1)}%</td><td>${q[i].toLocaleString('it-IT')}</td></tr>`).join('');
    rowsEl.innerHTML=html;
    // kpi nostri
    const rev=netP(me.p)*q[0], cost=costU(me.Q)*q[0], prof=rev-cost-500;
    document.getElementById('profit').textContent=euro(prof);
    document.getElementById('share').textContent=(s[0]*100).toFixed(1)+'%';
  }

  // ---- mosse competitor
  function moveA(){ // price-war
    const target=Math.max(12, me.p*0.95); A.p=clamp(A.p*0.6+target*0.4,10,120);
  }
  function moveB(){ // premium
    if(day%2===0 && Math.random()<0.6) Bc.B=clamp(Bc.B+1,1,5);
    else if(Math.random()<0.5) Bc.Q=clamp(Bc.Q+1,1,5);
    Bc.p=clamp(Bc.p*1.01,30,140);
  }
  function banditChoose(){
    if(Math.random()<C.eps) return Math.floor(Math.random()*actions.length);
    let b=0; for(let i=1;i<actions.length;i++) if(C.Qvals[i]>C.Qvals[b]) b=i; return b;
  }
  function banditMove(){
    const players=[me,A,Bc,C]; const before=shares(players)[3];
    const i=banditChoose(), a=actions[i];
    C.p=clamp(C.p*(1+a.dp),10,140); if(a.dQ)C.Q=clamp(C.Q+a.dQ,1,5); if(a.dB)C.B=clamp(C.B+a.dB,1,5); if(a.dS)C.S=clamp(C.S+a.dS,1,5);
    const after=shares(players)[3], r=after-before; C.N[i]+=1; C.Qvals[i]=C.Qvals[i]+(r-C.Qvals[i])/C.N[i]; C.eps=Math.max(0.05,C.eps*0.98);
  }

  // ---- UI bindings
  document.getElementById('price').addEventListener('input',e=>{me.p=parseFloat(e.target.value); render();});
  document.getElementById('beta').addEventListener('input',e=>{beta=parseFloat(e.target.value)||0.08; render();});
  document.getElementById('season').addEventListener('input',e=>{season=parseInt(e.target.value||'0',10); render();});
  document.getElementById('next').addEventListener('click',()=>{
    moveA(); moveB(); banditMove(); day++; document.getElementById('day').textContent=day; if(day>10) day=1; render();
  });

  // ---- start
  render();
</script>
</body>
</html>
