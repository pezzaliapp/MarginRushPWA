<!doctype html>
<html lang="it">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover,maximum-scale=1"/>
  <title>Margin Rush ‚Äî v4.9 Pro (MC ‚Ä¢ Copertura ‚Ä¢ MoS ‚Ä¢ BE)</title>

  <!-- PWA -->
  <meta name="theme-color" content="#0b1220"/>
  <link rel="manifest" href="manifest.json">
  <link rel="apple-touch-icon" href="icon-192.png">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">

  <!-- === CSS DARK (default) === -->
  <style id="theme-dark">
  :root {
    --bg: #0b1220;
    --bg-card: #0f1930;
    --bg-box: #0c1530;
    --bg-pill: #132046;
    --border: #1f2d4f;
    --text: #eaf0ff;
    --text-muted: #a9b6db;
    --accent-blue: #87a7ff;
    --accent-red: #ff5b6b;
    --accent-yellow: #ffd166;
    --accent-green: #6be675;
  }
  *{box-sizing:border-box}
  body{margin:0;font:15.5px/1.5 system-ui,-apple-system,Segoe UI,Roboto,sans-serif;background:var(--bg);color:var(--text)}
  header{position:sticky;top:0;z-index:10;background:linear-gradient(180deg,rgba(11,18,32,.96),rgba(11,18,32,.85));border-bottom:1px solid var(--border)}
  .wrap{max-width:1200px;margin:0 auto;padding:14px}
  h1{margin:0;font-size:1.1rem}
  .pill{display:inline-block;padding:2px 8px;border:1px solid var(--border);border-radius:999px;background:var(--bg-pill);margin-left:6px}
  .top{display:flex;flex-wrap:wrap;gap:8px;margin-top:8px}
  .badge{display:inline-block;padding:6px 10px;border:1px solid var(--border);border-radius:10px;background:var(--bg-box)}
  .btn{background:#1a2647;color:var(--text);border:1px solid var(--border);padding:9px 12px;border-radius:10px;cursor:pointer;font-size:.9rem}
  .btn.primary{background:var(--accent-blue);color:var(--bg);border:none;font-weight:700}
  .btn.danger{background:var(--accent-red);color:var(--bg);border:none;font-weight:700}
  .grid{display:grid;gap:12px;grid-template-columns:1fr 1fr}
  .card{background:var(--bg-card);border:1px solid var(--border);border-radius:14px;overflow:hidden}
  .card h3{margin:0;padding:10px;border-bottom:1px solid var(--border);font-size:1rem}
  .section{padding:10px}
  .kpi{display:grid;gap:8px;grid-template-columns:repeat(auto-fit,minmax(160px,1fr))}
  .box{padding:10px;border:1px solid var(--border);border-radius:10px;background:var(--bg-box)}
  .note{color:var(--text-muted);font-size:.9rem}
  table{width:100%;border-collapse:collapse;margin-top:6px}
  th,td{padding:6px;border-bottom:1px solid var(--border);text-align:right;font-size:.9rem}
  th:first-child,td:first-child{text-align:left}
  .controls-grid{display:grid;gap:10px 14px;grid-template-columns:minmax(160px,1fr) minmax(260px,2fr) minmax(120px,auto);align-items:center}
  .controls-grid .value{text-align:right;white-space:nowrap}
  .chart{width:100%;height:220px;background:#0b1432;border:1px solid var(--border);border-radius:10px;margin-top:8px}
  .log{max-height:220px;overflow:auto;border-top:1px solid var(--border);background:var(--bg-box)}
  .log-item{padding:7px 10px;border-bottom:1px dashed var(--border);font-size:.85rem;color:var(--text-muted)}
  .warn{color:#ffd166}
  .gain{color:#6be675}
  @media (max-width:1100px){.grid{grid-template-columns:1fr}}
  @media (max-width:900px){.kpi{grid-template-columns:1fr 1fr}}
  @media (max-width:420px){.kpi{grid-template-columns:1fr}.controls-grid{grid-template-columns:1fr}}
  </style>

  <!-- === CSS LIGHT (disattivato; verr√† abilitato via JS) === -->
  <style id="theme-light" disabled>
  :root {
    --bg: #f9fafc;
    --bg-card: #ffffff;
    --bg-box: #f2f4f9;
    --bg-pill: #dde3f7;
    --border: #cfd6e6;
    --text: #1c2230;
    --text-muted: #5a678a;
    --accent-blue: #0b5fff;
    --accent-red: #ff3b30;
    --accent-yellow: #f6c744;
    --accent-green: #28a745;
  }
  *{box-sizing:border-box}
  body{margin:0;font:15.5px/1.5 system-ui,-apple-system,Segoe UI,Roboto,sans-serif;background:var(--bg);color:var(--text)}
  header{position:sticky;top:0;z-index:10;background:linear-gradient(180deg,rgba(255,255,255,.96),rgba(255,255,255,.9));border-bottom:1px solid var(--border)}
  .wrap{max-width:1200px;margin:0 auto;padding:14px}
  h1{margin:0;font-size:1.1rem}
  .pill{display:inline-block;padding:2px 8px;border:1px solid var(--border);border-radius:999px;background:var(--bg-pill);margin-left:6px}
  .top{display:flex;flex-wrap:wrap;gap:8px;margin-top:8px}
  .badge{display:inline-block;padding:6px 10px;border:1px solid var(--border);border-radius:10px;background:var(--bg-box)}
  .btn{background:#fff;color:var(--text);border:1px solid var(--border);padding:9px 12px;border-radius:10px;cursor:pointer;font-size:.9rem}
  .btn.primary{background:var(--accent-blue);color:#fff;border:none;font-weight:700}
  .btn.danger{background:var(--accent-red);color:#fff;border:none;font-weight:700}
  .grid{display:grid;gap:12px;grid-template-columns:1fr 1fr}
  .card{background:var(--bg-card);border:1px solid var(--border);border-radius:14px;overflow:hidden}
  .card h3{margin:0;padding:10px;border-bottom:1px solid var(--border);font-size:1rem}
  .section{padding:10px}
  .kpi{display:grid;gap:8px;grid-template-columns:repeat(auto-fit,minmax(160px,1fr))}
  .box{padding:10px;border:1px solid var(--border);border-radius:10px;background:var(--bg-box)}
  .note{color:var(--text-muted);font-size:.9rem}
  table{width:100%;border-collapse:collapse;margin-top:6px}
  th,td{padding:6px;border-bottom:1px solid var(--border);text-align:right;font-size:.9rem}
  th:first-child,td:first-child{text-align:left}
  .controls-grid{display:grid;gap:10px 14px;grid-template-columns:minmax(160px,1fr) minmax(260px,2fr) minmax(120px,auto);align-items:center}
  .controls-grid .value{text-align:right;white-space:nowrap}
  .chart{width:100%;height:220px;background:#fff;border:1px solid var(--border);border-radius:10px;margin-top:8px}
  .log{max-height:220px;overflow:auto;border-top:1px solid var(--border);background:var(--bg-box)}
  .log-item{padding:7px 10px;border-bottom:1px dashed var(--border);font-size:.85rem;color:var(--text-muted)}
  @media (max-width:1100px){.grid{grid-template-columns:1fr}}
  @media (max-width:900px){.kpi{grid-template-columns:1fr 1fr}}
  @media (max-width:420px){.kpi{grid-template-columns:1fr}.controls-grid{grid-template-columns:1fr}}
  </style>
</head>
<body>

<header>
  <div class="wrap">
    <h1>Margin Rush <span class="pill">v4.9 Pro ‚Äî MC ‚Ä¢ Copertura ‚Ä¢ MoS ‚Ä¢ BE</span></h1>
    <div class="top">
      <div class="badge">Giorno: <b id="day">1</b>/10</div>
      <div class="badge">Cassa: <b id="cash">‚Ç¨5.000,00</b></div>
      <div class="badge">Quota oggi: <b id="share">0%</b></div>
      <div class="badge">Utile cumulato: <b id="cumprofit">‚Ç¨0,00</b></div>
      <button id="advance" class="btn primary">Avanza giorno</button>
      <button id="reset" class="btn danger">Nuova partita</button>
      <button id="show-solution" class="btn">üí° Indica la soluzione</button>
      <button id="toggle-theme" class="btn">üåó Tema</button>
    </div>
  </div>
</header>

<main class="wrap">
  <div class="grid">
    <div class="card">
      <h3>Il mercato (noi vs 3 competitor)</h3>
      <div class="section">
        <div class="kpi">
          <div class="box">Mercato M: <b id="M">1200</b></div>
          <div class="box">Stagionalit√†: <b id="seasonEcho">+0%</b></div>
          <div class="box">Œ≤ sensibilit√† prezzo: <b id="betaEcho">0.080</b></div>
          <div class="box">Capienza: <b id="capEcho">1000</b></div>
        </div>
        <table id="tbl">
          <thead><tr><th>Offerta</th><th>Prezzo</th><th>Q</th><th>B</th><th>S</th><th>Quota</th><th>Unit√†</th></tr></thead>
          <tbody></tbody>
        </table>
      </div>
      <div class="log" id="log"></div>
    </div>

    <div class="card">
      <h3>Leve, costi, canali</h3>
      <div class="section">
        <div class="controls-grid">
          <div>Prezzo nostro</div>
          <div><input id="price" type="range" min="5" max="120" step="0.5" value="49"></div>
          <div class="value"><b id="priceEcho">‚Ç¨49,00</b></div>

          <div>Qualit√† (Q)</div>
          <div><input id="invQ" type="range" min="0" max="3" step="1" value="1"></div>
          <div class="value"><b id="invQEcho">1</b></div>

          <div>Brand (B)</div>
          <div><input id="invB" type="range" min="0" max="3" step="1" value="1"></div>
          <div class="value"><b id="invBEcho">1</b></div>

          <div>Servizio (S)</div>
          <div><input id="invS" type="range" min="0" max="2" step="1" value="1"></div>
          <div class="value"><b id="invSEcho">1</b></div>

          <div>Capienza ordini/g</div>
          <div><input id="cap" type="range" min="300" max="3000" step="50" value="1000"></div>
          <div class="value"><b id="capVal">1000</b></div>
        </div>

        <div class="kpi" style="margin-top:6px">
          <div class="box">IVA inclusa? <input type="checkbox" id="iva" checked></div>
          <div class="box">IVA % <input type="number" id="ivaPct" value="22" step="0.1"></div>
          <div class="box">Œ≤ <input type="number" id="beta" value="0.08" step="0.005"></div>
          <div class="box">Stag. % <input type="number" id="season" value="0" step="1"></div>
        </div>

        <h4 style="margin:10px 0 6px">Costi variabili & vincoli prezzo</h4>
        <div class="kpi">
          <div class="box">Prezzo d‚Äôacquisto ‚Ç¨/u<br><input type="number" id="buyCost" value="20" step="0.1"></div>
          <div class="box">Overhead variabile ‚Ç¨/u<br><input type="number" id="varOver" value="1.20" step="0.1"></div>
          <div class="box">Margine minimo %<br><input type="number" id="minMarginPct" value="15" step="0.5"></div>
          <div class="box">Stato margine<br><b id="minMarginWarn">‚Äî</b></div>
        </div>

        <fieldset>
          <legend>Garanzia</legend>
          <div class="kpi">
            <div class="box">Livello (mesi)<br>
              <select id="wTier">
                <option value="12">12</option>
                <option value="24" selected>24</option>
                <option value="36">36</option>
                <option value="60">60</option>
              </select>
            </div>
            <div class="box">In garanzia %<br><input type="number" id="wRateIn" value="3" step="0.1"></div>
            <div class="box">Costo in garanzia ‚Ç¨<br><input type="number" id="wCostIn" value="40" step="1"></div>
            <div class="box">Goodwill % / ‚Ç¨<br>
              <input type="number" id="wRateOut" value="1" step="0.1" style="width:60px"> /
              <input type="number" id="wCostOut" value="30" step="1" style="width:60px">
            </div>
          </div>
          <div class="kpi">
            <div class="box">Costo garanzia/u<br><b id="wCostPerUnit">‚Ç¨0,00</b></div>
            <div class="box">MC/u (tutto incluso)<br><b id="mcUnit">‚Ç¨0,00</b></div>
            <div class="box">Imposta utile %<br><input type="number" id="taxPct" value="24" step="0.1"></div>
            <div class="box">BE u/g (post-tax)<br><b id="beUnits">‚Äî</b></div>
          </div>
        </fieldset>

        <fieldset>
          <legend>Costi fissi base (giornalieri)</legend>
          <div class="kpi">
            <div class="box">Personale ‚Ç¨/g<br><input type="number" id="fxStaff" value="300" step="10"></div>
            <div class="box">Affitto ‚Ç¨/g<br><input type="number" id="fxRent" value="120" step="10"></div>
            <div class="box">SaaS ‚Ç¨/g<br><input type="number" id="fxSaaS" value="60" step="5"></div>
            <div class="box">Altro ‚Ç¨/g<br><input type="number" id="fxOther" value="20" step="5"></div>
          </div>
        </fieldset>

        <fieldset>
          <legend>Canale di vendita</legend>
          <div class="kpi">
            <div class="box">Canale<br>
              <select id="channel">
                <option value="online" selected>Vendita on-line</option>
                <option value="piva">Venditore a P.IVA</option>
                <option value="employee">Dipendente</option>
              </select>
            </div>
            <div class="box">Fissi canale/g<br><b id="chFixedEcho">‚Ç¨0,00</b></div>
            <div class="box">Variabile canale/u<br><b id="chVarEcho">‚Ç¨0,00</b></div>
            <div class="box">Commissione % su netto<br><b id="chPctEcho">0%</b></div>
          </div>

          <!-- ONLINE -->
          <div id="ch-online">
            <div class="kpi">
              <div class="box">Fee piattaforma %<br><input type="number" id="onFeePct" value="6" step="0.1"></div>
              <div class="box">Fee pagamento %<br><input type="number" id="onPayPct" value="2.5" step="0.1"></div>
              <div class="box">Fee fissa ordine ‚Ç¨<br><input type="number" id="onFixedPer" value="0.35" step="0.05"></div>
              <div class="box">Logistica ‚Ç¨/u<br><input type="number" id="onLogPer" value="3" step="0.1"></div>
            </div>
            <div class="kpi">
              <div class="box">SaaS ‚Ç¨/mese<br><input type="number" id="onSaaS" value="100" step="5"></div>
              <div class="box">Gestione store ‚Ç¨/mese<br><input type="number" id="onMgmt" value="150" step="5"></div>
            </div>
          </div>

          <!-- P.IVA -->
          <div id="ch-piva" style="display:none">
            <div class="kpi">
              <div class="box">Auto a noleggio ‚Ç¨/mese<br><input type="number" id="pvAuto" value="400" step="10"></div>
              <div class="box">Compenso fisso ‚Ç¨/mese<br><input type="number" id="pvFixed" value="2000" step="50"></div>
              <div class="box">Provvigione %<br><input type="number" id="pvPct" value="10" step="0.5"></div>
              <div class="box">Telepass ‚Ç¨/km<br><input type="number" id="pvTeleKm" value="0.07" step="0.01"></div>
            </div>
            <div class="kpi">
              <div class="box">Km/mese<br><input type="number" id="pvKm" value="4000" step="100"></div>
              <div class="box">Consumo km/l<br><input type="number" id="pvKml" value="18" step="0.1"></div>
              <div class="box">Carburante ‚Ç¨/l<br><input type="number" id="pvFuel" value="1.70" step="0.01"></div>
              <div class="box">Altre spese ‚Ç¨/mese<br><input type="number" id="pvOtherM" value="0" step="5"></div>
            </div>
          </div>

          <!-- DIPENDENTE -->
          <div id="ch-employee" style="display:none">
            <div class="kpi">
              <div class="box">RAL annua ‚Ç¨<br><input type="number" id="emRal" value="50000" step="500"></div>
              <div class="box">Auto aziendale ‚Ç¨/mese<br><input type="number" id="emAuto" value="450" step="10"></div>
              <div class="box">Telepass ‚Ç¨/mese<br><input type="number" id="emTele" value="30" step="1"></div>
              <div class="box">Trasferte ‚Ç¨/mese<br><input type="number" id="emTrips" value="250" step="10"></div>
            </div>
            <div class="kpi">
              <div class="box">Provvigione % (opz.)<br><input type="number" id="emPct" value="0" step="0.5"></div>
              <div class="box">Km/mese (opz.)<br><input type="number" id="emKm" value="0" step="100"></div>
              <div class="box">Consumo km/l<br><input type="number" id="emKml" value="18" step="0.1"></div>
              <div class="box">Carburante ‚Ç¨/l<br><input type="number" id="emFuel" value="1.70" step="0.01"></div>
            </div>
          </div>
        </fieldset>

        <div class="note" id="advisor" style="margin-top:8px">Advisor‚Ä¶</div>
        <div id="solution-box" class="box" style="display:none; margin-top:8px"></div>

        <canvas id="beChart" class="chart"></canvas>
        <canvas id="mcChart" class="chart"></canvas>
      </div>
    </div>
  </div>

  <div class="card" style="margin-top:12px">
    <h3>Report del giorno</h3>
    <div class="section">
      <div class="kpi">
        <div class="box">Unit√† nostre: <b id="qMe">0</b></div>
        <div class="box">Quota nostra: <b id="sMe">0%</b></div>
        <div class="box">Utile netto: <b id="pMe">‚Ç¨0,00</b></div>
        <div class="box">Clienti spostati: <b id="moved">0</b></div>
      </div>
      <div class="kpi" style="margin-top:8px">
        <div class="box">MC/u<br><b id="kpiMcUnit">‚Ç¨0,00</b></div>
        <div class="box">MC totale oggi<br><b id="kpiMcTotal">‚Ç¨0,00</b></div>
        <div class="box">Indice di copertura<br><b id="kpiCover">0%</b></div>
        <div class="box">Margine di sicurezza<br><b id="kpiMoS">‚Äî</b></div>
      </div>
      <div class="note" style="margin-top:6px">
        Œî clienti ‚Äî Prezzo: <b id="bp">0</b> ¬∑ Q: <b id="bq">0</b> ¬∑ B: <b id="bb">0</b> ¬∑ S: <b id="bs">0</b>
      </div>
    </div>
  </div>
</main>

<script>
/* ===== Service Worker ===== */
if ('serviceWorker' in navigator) {
  window.addEventListener('load', () => {
    navigator.serviceWorker
      .register('service-worker.js', { updateViaCache: 'all' })
      .then(reg => {
        reg.update();
        navigator.serviceWorker.addEventListener('controllerchange', () => {
          if (!window.__reloaded) { window.__reloaded = true; location.reload(); }
        });
        if (reg.waiting) reg.waiting.postMessage({ type: 'SKIP_WAITING' });
        reg.addEventListener('updatefound', () => {
          const nw = reg.installing;
          if (!nw) return;
          nw.addEventListener('statechange', () => {
            if (nw.state === 'installed' && navigator.serviceWorker.controller) {
              reg.waiting?.postMessage({ type: 'SKIP_WAITING' });
            }
          });
        });
      })
      .catch(err => console.error('‚ùå SW register error', err));
  });
}
</script>
<script>
/* ===== Tema ===== */
const THEME_KEY = "theme";
const darkStyle  = document.getElementById('theme-dark');
const lightStyle = document.getElementById('theme-light');
function applyTheme(theme){
  const isLight = theme === 'light';
  lightStyle.disabled = !isLight;
  darkStyle.disabled  =  isLight;
}
function getSystemTheme(){ return matchMedia("(prefers-color-scheme: light)").matches ? "light" : "dark"; }
(function initTheme(){
  const saved=localStorage.getItem(THEME_KEY);
  applyTheme(saved === 'light' || saved === 'dark' ? saved : getSystemTheme());
  const mq = matchMedia("(prefers-color-scheme: light)");
  const cb = ()=>{ const pref=localStorage.getItem(THEME_KEY); if (pref!=='light'&&pref!=='dark') applyTheme(getSystemTheme()); };
  if (mq.addEventListener) mq.addEventListener('change', cb); else mq.addListener(cb);
})();
document.getElementById("toggle-theme").addEventListener("click", () => {
  const next = lightStyle.disabled ? 'light' : 'dark';
  localStorage.setItem(THEME_KEY, next);
  applyTheme(next);
});

/* ====== Utils ====== */
const el = id => document.getElementById(id);
const euro = n => (Math.round((n ?? 0)*100)/100).toLocaleString('it-IT',{style:'currency',currency:'EUR'});
const pct = x => `${(x*100).toFixed(1)}%`;
const clamp=(x,a,b)=>Math.max(a,Math.min(b,x));
const save=(k,v)=>{ try{ localStorage.setItem(k,JSON.stringify(v)); }catch{} };
const load=(k,d)=>{ try{ const v=localStorage.getItem(k); return v?JSON.parse(v):d; }catch{ return d; } };

// LIMITE GIORNI
const MAX_DAYS = 10;

/* ====== Stato ====== */
let day = load('day', 1);
let M = load('M', 1200);
let beta = load('beta', 0.08);
let season = load('season', 0);
let cap = load('cap', 1000);

let ivaIncl = load('ivaIncl', true);
let ivaPct = load('ivaPct', 22)/100;
let tax = load('tax', 24)/100;

let our = load('our', { name: "Noi", p: 49, Q: 1, B: 1, S: 1 });

let buyCost   = load('buyCost', 20);
let varOver   = load('varOver', 1.2);
let minMargin = load('minMargin', 15);

let warranty = load('warranty', { months: 24, rateIn: 3, costIn: 40, rateOut: 1, costOut: 30 });

let fixedBase = load('fixedBase', { staff: 300, rent: 120, saas: 60, other: 20 });

let channel = load('channel', 'online');
let ch = load('chParams', {
  online:   { feePct: 6,  payPct: 2.5, fixedPer: 0.35, logPer: 3, saasM: 100, mgmtM:150 },
  piva:     { autoM:400, fixedM:2000, pct:10, teleKm:0.07, kmM:4000, kml:18, fuel:1.7, otherM:0 },
  employee: { ralY:50000, autoM:450,  teleM:30, tripsM:250, pct:0, kmM:0,   kml:18, fuel:1.7 }
});

let cash = load('cash', 5000);
let cumProfit = load('cumProfit', 0);

let comps = load('comps', [
  { name:"Comp A (Price-war)", p:45, Q:1, B:1, S:1, strat:"price" },
  { name:"Comp B (Premium)",  p:70, Q:2, B:2, S:2, strat:"premium" },
  { name:"Comp C (Bandit)",   p:52, Q:1, B:1, S:1, strat:"bandit",
    actions:[
      { dp:-.10, name:"Price ‚àí10%" },
      { dp:-.05, name:"Price ‚àí5%"  },
      { dQ: 1,   name:"+Q"         },
      { dB: 1,   name:"+B"         },
      { dS: 1, dp:+.05, name:"+S & +5%" }
    ],
    Qvals:[0,0,0,0,0], N:[0,0,0,0,0], epsilon:0.25
  }
]);

let lastShares = null;
let lastMyUnits = 0;
let prev = {p:our.p,Q:our.Q,B:our.B,S:our.S,share:0,units:0};
window.lastAdvisorPrice = null;

/* ====== Funzioni core ====== */
const netP = p => ivaIncl ? p/(1+ivaPct) : p;
const costQ = Q => 8 + 2*Q;

function wCostPerUnit(){
  const rin  = (+el('wRateIn')?.value || warranty.rateIn)/100;
  const rout = (+el('wRateOut')?.value || warranty.rateOut)/100;
  const cin  = (+el('wCostIn')?.value || warranty.costIn);
  const cout = (+el('wCostOut')?.value || warranty.costOut);
  return rin*cin + rout*cout;
}
function channelFixedPerDay(){
  if (channel==='online'){
    const saas = +el('onSaaS')?.value || ch.online.saasM;
    const mgmt = +el('onMgmt')?.value || ch.online.mgmtM;
    return (saas + mgmt)/30;
  }
  if (channel==='piva'){
    const km   = +el('pvKm')?.value || ch.piva.kmM;
    const kml  = +el('pvKml')?.value || ch.piva.kml || 1;
    const fuel = +el('pvFuel')?.value || ch.piva.fuel;
    const tele = +el('pvTeleKm')?.value || ch.piva.teleKm;
    const otherM = +el('pvOtherM')?.value || ch.piva.otherM;
    const fuelM = km/kml*fuel;
    const teleM = km*tele;
    return ((+el('pvAuto')?.value||ch.piva.autoM) + (+el('pvFixed')?.value||ch.piva.fixedM) + fuelM + teleM + otherM)/30;
  }
  const ralD = (+el('emRal')?.value || ch.employee.ralY)/365;
  const autoD= (+el('emAuto')?.value || ch.employee.autoM)/30;
  const teleD= (+el('emTele')?.value || ch.employee.teleM)/30;
  const tripD= (+el('emTrips')?.value || ch.employee.tripsM)/30;
  return ralD + autoD + teleD + tripD;
}
function channelVarPerUnit(pNet){
  if (channel==='online'){
    const feePct = (+el('onFeePct')?.value || ch.online.feePct)/100;
    const payPct = (+el('onPayPct')?.value || ch.online.payPct)/100;
    const fixed  = (+el('onFixedPer')?.value || ch.online.fixedPer);
    const logPer = (+el('onLogPer')?.value || ch.online.logPer);
    return pNet*(feePct+payPct) + fixed + logPer;
  }
  if (channel==='piva'){
    const pct = (+el('pvPct')?.value || ch.piva.pct)/100;
    return pNet*pct;
  }
  const pct = (+el('emPct')?.value || ch.employee.pct)/100;
  return pNet*pct;
}
function fixedTotalPerDay(){
  const base = (+el('fxStaff')?.value || fixedBase.staff) + (+el('fxRent')?.value || fixedBase.rent) +
               (+el('fxSaaS')?.value || fixedBase.saas) + (+el('fxOther')?.value || fixedBase.other);
  return base + channelFixedPerDay();
}
function shares(players){
  const U = players.map(o=>{
    const base = 0.6 + (o.B-1)*.15 + (o.Q-1)*.2;
    const price = -beta*o.p;
    const q = .25*(o.Q-1), b = .20*(o.B-1), s=.15*(o.S-1);
    const shock = (season/100)*(0.1+0.2*(o.B-1));
    return base + price + q + b + s + shock;
  });
  const mx = Math.max(...U);
  const ex = U.map(u=>Math.exp(u-mx));
  const sum = ex.reduce((a,b)=>a+b,0);
  return ex.map(e=>e/sum);
}

/* ====== Chart: BE ====== */
function drawBEChart(q, pNet, vc, F){
  const cvs = el('beChart'); if (!cvs) return;
  const ctx = cvs.getContext('2d');
  const W = cvs.clientWidth || 600, H = cvs.clientHeight || 220;
  if (cvs.width !== W) cvs.width = W;
  if (cvs.height!== H) cvs.height= H;

  ctx.clearRect(0,0,W,H);
  ctx.strokeStyle="#30406e"; ctx.lineWidth=1;
  ctx.beginPath(); ctx.moveTo(40,H-30); ctx.lineTo(W-10,H-30); ctx.stroke();
  ctx.beginPath(); ctx.moveTo(40,H-30); ctx.lineTo(40,10); ctx.stroke();

  const maxX = Math.max(q*1.2, 10);
  const x2px = x => 40 + (W-60)*(x/maxX);
  const y2px = y => (H-30) - (H-50)*(y/Math.max(pNet*maxX, (vc*maxX+F)*1.3, 1));

  ctx.strokeStyle="#6ba8ff"; ctx.beginPath();
  for (let x=0;x<=maxX;x+=maxX/40){
    const y = pNet*x;
    const X=x2px(x), Y=y2px(y);
    if (x===0) ctx.moveTo(X,Y); else ctx.lineTo(X,Y);
  } ctx.stroke();

  ctx.strokeStyle="#ff7a88"; ctx.beginPath();
  for (let x=0;x<=maxX;x+=maxX/40){
    const y = vc*x + F;
    const X=x2px(x), Y=y2px(y);
    if (x===0) ctx.moveTo(X,Y); else ctx.lineTo(X,Y);
  } ctx.stroke();

  const mcUnit = Math.max(pNet - vc, 0.0001);
  const beUnits = F / (mcUnit*(1 - tax || 1));
  const beX = x2px(beUnits);
  ctx.strokeStyle="#ffd166"; ctx.setLineDash([4,4]);
  ctx.beginPath(); ctx.moveTo(beX,10); ctx.lineTo(beX,H-30); ctx.stroke();
  ctx.setLineDash([]);

  ctx.fillStyle="#a9b6db"; ctx.font="12px system-ui";
  ctx.fillText("Unit√†", W-48, H-12);
  ctx.save(); ctx.translate(12, 20); ctx.rotate(-Math.PI/2);
  ctx.fillText("‚Ç¨", 0, 0); ctx.restore();

  ctx.fillStyle="#6ba8ff"; ctx.fillRect(50,14,10,10); ctx.fillStyle="#a9b6db"; ctx.fillText("Ricavi", 65,24);
  ctx.fillStyle="#ff7a88"; ctx.fillRect(120,14,10,10); ctx.fillStyle="#a9b6db"; ctx.fillText("Costi totali", 135,24);
  ctx.fillStyle="#ffd166"; ctx.fillRect(210,14,10,10); ctx.fillStyle="#a9b6db"; ctx.fillText("Break-even", 225,24);
}

/* ====== Chart: MC ====== */
function drawMCChart(q, pNet, vc){
  const cvs = el('mcChart'); if (!cvs) return;
  const ctx = cvs.getContext('2d');
  const W = cvs.clientWidth || 600, H = cvs.clientHeight || 220;
  if (cvs.width !== W) cvs.width = W;
  if (cvs.height!== H) cvs.height= H;

  ctx.clearRect(0,0,W,H);
  ctx.strokeStyle="#30406e"; ctx.lineWidth=1;
  ctx.beginPath(); ctx.moveTo(40,H-30); ctx.lineTo(W-10,H-30); ctx.stroke();
  ctx.beginPath(); ctx.moveTo(40,H-30); ctx.lineTo(40,10); ctx.stroke();

  const maxX = Math.max(q*1.2, 10);
  const x2px = x => 40 + (W-60)*(x/maxX);
  const yMax = Math.max(pNet*maxX, vc*maxX, 1);
  const y2px = y => (H-30) - (H-50)*(y/ yMax);

  ctx.strokeStyle="#6ba8ff"; ctx.beginPath();
  for (let x=0;x<=maxX;x+=maxX/40){
    const y=pNet*x, X=x2px(x), Y=y2px(y);
    if (x===0) ctx.moveTo(X,Y); else ctx.lineTo(X,Y);
  } ctx.stroke();

  ctx.strokeStyle="#ff7a88"; ctx.beginPath();
  for (let x=0;x<=maxX;x+=maxX/40){
    const y=vc*x, X=x2px(x), Y=y2px(y);
    if (x===0) ctx.moveTo(X,Y); else ctx.lineTo(X,Y);
  } ctx.stroke();

  const Q = Math.max(0, Math.min(q||0, maxX));
  ctx.fillStyle="rgba(107,230,117,0.25)";
  ctx.beginPath();
  ctx.moveTo(x2px(0),y2px(0)); ctx.lineTo(x2px(Q),y2px(pNet*Q)); ctx.lineTo(x2px(Q),y2px(vc*Q)); ctx.lineTo(x2px(0),y2px(0));
  ctx.fill();

  ctx.fillStyle="#6ba8ff"; ctx.fillRect(50,14,10,10); ctx.fillStyle="#a9b6db"; ctx.fillText("Ricavi netti", 65,24);
  ctx.fillStyle="#ff7a88"; ctx.fillRect(140,14,10,10); ctx.fillStyle="#a9b6db"; ctx.fillText("Costi variabili", 155,24);
  ctx.fillStyle="#6be675"; ctx.fillRect(240,14,10,10); ctx.fillStyle="#a9b6db"; ctx.fillText("MC (area)", 255,24);
}

/* ====== Advisor prezzo ====== */
function runAdvisor(){
  const F = fixedTotalPerDay();
  const market = Math.round(M * (1 + season/100));
  let best = our.p;
  let bestProf = -Infinity;

  for (let p = 10; p <= 120; p += 0.5) {
    const s = shares([{...our, p}].concat(comps))[0];
    const q = Math.min(Math.round(s * market), cap);

    const pNet = netP(p);
    const vc = buyCost + varOver + costQ(our.Q) + wCostPerUnit() + channelVarPerUnit(pNet);

    const preTax = Math.max(0, pNet - vc) * q - F;
    const postTax = preTax > 0 ? preTax * (1 - tax) : preTax;

    if (postTax > bestProf) {
      bestProf = postTax;
      best = p;
    }
  }

  window.lastAdvisorPrice = best;
  if (el('advisor')) el('advisor').innerHTML = `Advisor: <b>${euro(best)}</b> ‚Äî utile atteso ${euro(bestProf)} (post-tax).`;
}

/* ====== UI refresh ====== */
function refreshEcho(){
  if (el('price')) our.p = +el('price').value || our.p;
  if (el('invQ'))  our.Q = +el('invQ').value  || our.Q;
  if (el('invB'))  our.B = +el('invB').value  || our.B;
  if (el('invS'))  our.S = +el('invS').value  || our.S;
  if (el('cap'))   cap   = +el('cap').value   || cap;

  if (el('iva'))     ivaIncl = !!el('iva').checked;
  if (el('ivaPct'))  ivaPct = (+el('ivaPct').value || ivaPct*100)/100;
  if (el('beta'))    beta = +el('beta').value || beta;
  if (el('season'))  season = +el('season').value || season;

  if (el('priceEcho')) el('priceEcho').textContent = euro(our.p);
  if (el('invQEcho'))  el('invQEcho').textContent  = our.Q;
  if (el('invBEcho'))  el('invBEcho').textContent  = our.B;
  if (el('invSEcho'))  el('invSEcho').textContent  = our.S;
  if (el('capVal'))    el('capVal').textContent    = cap;
  if (el('capEcho'))   el('capEcho').textContent   = cap;
  if (el('M'))         el('M').textContent = M;
  if (el('seasonEcho'))el('seasonEcho').textContent = (season>=0?'+':'') + season + '%';
  if (el('betaEcho'))  el('betaEcho').textContent = beta.toFixed(3);

  const players = [our].concat(comps);
  const s = shares(players);
  const market = Math.round(M * (1 + season/100));
  const qList = s.map(si => Math.min(Math.round(si * market), cap));

  const tbody = el('tbl')?.querySelector('tbody');
  if (tbody){
    tbody.innerHTML = '';
    players.forEach((p,i)=>{
      const tr = document.createElement('tr');
      const cols = [
        p.name ?? (i===0?'Noi':'Comp'),
        euro(p.p),
        p.Q, p.B, p.S,
        pct(s[i]),
        qList[i].toString()
      ];
      cols.forEach((c)=>{
        const td = document.createElement('td');
        td.textContent = c;
        tr.appendChild(td);
      });
      tbody.appendChild(tr);
    });
  }

  const pNet = netP(our.p);
  const vc = buyCost + varOver + costQ(our.Q) + wCostPerUnit() + channelVarPerUnit(pNet);
  const mcUnit = pNet - vc;
  const F = fixedTotalPerDay();
  const denom = Math.max(mcUnit*(1-tax), 0.000001);
  const beUnits = F / denom;

  if (el('wCostPerUnit')) el('wCostPerUnit').textContent = euro(wCostPerUnit());
  if (el('mcUnit'))       el('mcUnit').textContent       = euro(mcUnit);
  if (el('beUnits'))      el('beUnits').textContent      = isFinite(beUnits)? beUnits.toFixed(1) : '‚Äî';

  const myQ = qList[0];
  const mcTot = Math.max(0, mcUnit) * myQ;
  if (el('kpiMcUnit'))  el('kpiMcUnit').textContent  = euro(mcUnit);
  if (el('kpiMcTotal')) el('kpiMcTotal').textContent = euro(mcTot);
  if (el('kpiCover'))   el('kpiCover').textContent   = mcUnit>0? pct(mcUnit/pNet) : '0%';
  const mos = (myQ>0 && beUnits>0) ? (myQ - beUnits)/myQ : 0;
  if (el('kpiMoS'))     el('kpiMoS').textContent = isFinite(mos)? pct(clamp(mos,-1,1)) : '‚Äî';

  if (el('minMarginWarn')){
    const minNet = (buyCost + varOver + costQ(our.Q) + wCostPerUnit());
    const minPNet = minNet / (1 - minMargin/100);
    const minPLordo = ivaIncl ? minPNet*(1+ivaPct) : minPNet;
    el('minMarginWarn').textContent = our.p < minPLordo ? '‚ö†Ô∏è sotto margine minimo' : 'OK';
  }

  drawBEChart(myQ, pNet, vc, F);
  drawMCChart(myQ, pNet, vc);

  runAdvisor();

  if (el('day'))       el('day').textContent = day;
  if (el('cash'))      el('cash').textContent = euro(cash);
  if (el('cumprofit')) el('cumprofit').textContent = euro(cumProfit);
  if (el('share'))     el('share').textContent = pct(s[0]||0);

  save('day',day); save('M',M); save('beta',beta); save('season',season); save('cap',cap);
  save('ivaIncl',ivaIncl); save('ivaPct',ivaPct*100); save('tax',tax*100);
  save('our',our); save('buyCost',buyCost); save('varOver',varOver); save('minMargin',minMargin);
  save('warranty',warranty); save('fixedBase',fixedBase);
  save('channel',channel); save('chParams',ch);
  save('cash',cash); save('cumProfit',cumProfit);
  save('comps',comps);
}

/* ====== Simulazione ====== */
function log(t){
  const logEl = el('log'); if (!logEl) return;
  const d=document.createElement('div');
  d.className='log-item';
  d.textContent = `[G${day}] ${t}`;
  logEl.prepend(d);
}

function compMovePriceWar(c){
  if (lastShares){
    const idx = 1 + comps.findIndex(x=>x.name===c.name);
    const myS = lastShares[0], theirS = lastShares[idx] ?? 0;
    if (myS > theirS) c.p = clamp(c.p * 0.98, 8, 200);
    else c.p = clamp(c.p * 1.01, 8, 200);
  } else {
    c.p = clamp(c.p * 0.99, 8, 200);
  }
}
function compMovePremium(c){
  if (Math.random()<0.5) c.Q = clamp(c.Q+1,1,3);
  else c.B = clamp(c.B+1,1,3);
  c.S = clamp(c.S + (Math.random()<0.3?1:0),1,2);
  c.p = clamp(c.p * (1 + (Math.random()<0.5?-0.01:0.01)), 10, 220);
}
function compMoveBandit(c){
  const eps = c.epsilon ?? 0.25;
  let aIdx;
  if (Math.random() < eps){
    aIdx = Math.floor(Math.random()*c.actions.length);
  } else {
    let best=-Infinity, idx=0;
    c.Qvals.forEach((q,i)=>{ if(q>best){best=q; idx=i;} });
    aIdx = idx;
  }
  const a = c.actions[aIdx];
  const basePlayers = [our].concat(comps.map(x=>({...x})));
  const beforeS = shares(basePlayers);
  const meIdx = 1 + comps.findIndex(x=>x.name===c.name);
  const before = beforeS[meIdx];

  const simPlayers = [our].concat(comps.map(x=>{
    if (x.name!==c.name) return {...x};
    const nx = {...x};
    if (a.dp) nx.p = clamp(nx.p*(1+a.dp), 5, 220);
    if (a.dQ) nx.Q = clamp(nx.Q + a.dQ, 1, 3);
    if (a.dB) nx.B = clamp(nx.B + a.dB, 1, 3);
    if (a.dS) nx.S = clamp(nx.S + a.dS, 1, 2);
    return nx;
  }));
  const after = shares(simPlayers)[meIdx];

  const reward = after - before;
  c.N[aIdx] += 1;
  c.Qvals[aIdx] = c.Qvals[aIdx] + (reward - c.Qvals[aIdx]) / c.N[aIdx];

  if (a.dp) c.p = clamp(c.p*(1+a.dp), 5, 220);
  if (a.dQ) c.Q = clamp(c.Q + a.dQ, 1, 3);
  if (a.dB) c.B = clamp(c.B + a.dB, 1, 3);
  if (a.dS) c.S = clamp(c.S + a.dS, 1, 2);

  log(`${c.name}: ${a.name} | Œîshare ${(reward*100).toFixed(1)}pp`);
}

function simulateDay(){
  const playersBefore = [our].concat(comps);
  const s = shares(playersBefore);
  const market = Math.round(M * (1 + season/100));
  const q = s.map(x => Math.round(x * market));
  q[0] = Math.min(q[0], cap);
  const myQ = q[0];

  const pNet = netP(our.p);
  const vc = buyCost + varOver + costQ(our.Q) + wCostPerUnit() + channelVarPerUnit(pNet);
  const F  = fixedTotalPerDay();

  const mcUnit  = pNet - vc;
  const preTax  = Math.max(0, mcUnit) * myQ - F;
  const postTax = preTax > 0 ? preTax * (1 - tax) : preTax;

  cash += postTax;
  cumProfit += postTax;

  if (el('qMe')) el('qMe').textContent = myQ.toLocaleString('it-IT');
  if (el('sMe')) el('sMe').textContent = (s[0]*100).toFixed(1) + '%';
  if (el('pMe')) el('pMe').textContent = euro(postTax);

  const s_now = s[0];
  const moved = Math.round((s_now - (prev?.share ?? s_now)) * market);
  if (el('moved')) el('moved').textContent = (moved>=0?'+':'') + moved.toLocaleString('it-IT');

  if (prev){
    const deltaAbs = Math.abs(moved);
    const bp = (our.p !== prev.p) ? -Math.sign(our.p - prev.p) * Math.round(deltaAbs * 0.50) : 0;
    const bq = (our.Q - prev.Q) * Math.round(deltaAbs * 0.25);
    const bb = (our.B - prev.B) * Math.round(deltaAbs * 0.15);
    const bs = (our.S - prev.S) * Math.round(deltaAbs * 0.10);
    if (el('bp')) el('bp').textContent = (bp>=0?'+':'') + bp;
    if (el('bq')) el('bq').textContent = (bq>=0?'+':'') + bq;
    if (el('bb')) el('bb').textContent = (bb>=0?'+':'') + bb;
    if (el('bs')) el('bs').textContent = (bs>=0?'+':'') + bs;
  }

  const tbody = el('tbl')?.querySelector('tbody');
  if (tbody){
    tbody.innerHTML = '';
    [our].concat(comps).forEach((p,i)=>{
      const tr = document.createElement('tr');
      const cols = [i===0?'Noi':p.name, euro(p.p), p.Q, p.B, p.S, ((s[i]*100).toFixed(1)+'%'), (q[i] ?? 0).toString()];
      cols.forEach(c=>{ const td=document.createElement('td'); td.textContent=c; tr.appendChild(td); });
      tbody.appendChild(tr);
    });
  }

  drawBEChart(myQ, pNet, vc, F);
  drawMCChart(myQ, pNet, vc);
  runAdvisor();

  if (el('cash')) el('cash').textContent = euro(cash);
  if (el('cumprofit')) el('cumprofit').textContent = euro(cumProfit);
  if (el('share')) el('share').textContent = (s[0]*100).toFixed(1)+'%';

  lastShares   = s;
  lastMyUnits  = myQ;
  prev = { p:our.p, Q:our.Q, B:our.B, S:our.S, share:s_now, units:myQ };

  comps.forEach(c=>{
    if (c.strat==='price') compMovePriceWar(c);
    else if (c.strat==='premium') compMovePremium(c);
    else compMoveBandit(c);
  });

  log(`Noi ‚Äî prezzo ${euro(our.p)}, quota ${(s[0]*100).toFixed(1)}%, unit√† ${myQ.toLocaleString('it-IT')}, utile ${euro(postTax)}`);

  // BLOCCO a 10 giorni
  day++;
  if (day > MAX_DAYS) day = MAX_DAYS;
  if (el('day')) el('day').textContent = day;
  save('day', day);

  if (day >= MAX_DAYS) {
    const adv = el('advance');
    if (adv) { adv.disabled = true; adv.textContent = 'Partita conclusa'; }
    log('üéâ Fine partita (G10).');
  }

  refreshEcho();
}

/* ====== Wiring ====== */
function showChannelPanels(){
  const m = { online: el('ch-online'), piva: el('ch-piva'), employee: el('ch-employee') };
  Object.values(m).forEach(n=>{ if(n) n.style.display='none'; });
  if (m[channel]) m[channel].style.display='block';

  const pNet = netP(our.p);
  if (el('chVarEcho')) el('chVarEcho').textContent = euro(channelVarPerUnit(pNet));
  if (el('chFixedEcho')) el('chFixedEcho').textContent = euro(channelFixedPerDay());
  if (el('chPctEcho')){
    const pctV =
      channel==='online' ? ((+el('onFeePct').value||ch.online.feePct)+(+el('onPayPct').value||ch.online.payPct)) :
      channel==='piva'   ? (+el('pvPct').value||ch.piva.pct) :
                           (+el('emPct').value||ch.employee.pct);
    el('chPctEcho').textContent = `${Number(pctV).toFixed(1)}%`;
  }
}
function bind(id, ev, fn){ const x=el(id); if (x) x.addEventListener(ev, fn); }
function hydrateInputs(){
  el('price').value = our.p;
  el('invQ').value  = our.Q;
  el('invB').value  = our.B;
  el('invS').value  = our.S;
  el('cap').value   = cap;
  el('iva').checked = ivaIncl;
  el('ivaPct').value= (ivaPct*100).toFixed(1);
  el('beta').value  = beta;
  el('season').value= season;

  el('buyCost').value=buyCost;
  el('varOver').value=varOver;
  el('minMarginPct').value=minMargin;
  el('taxPct').value=(tax*100).toFixed(1);

  el('fxStaff').value=fixedBase.staff;
  el('fxRent').value=fixedBase.rent;
  el('fxSaaS').value=fixedBase.saas;
  el('fxOther').value=fixedBase.other;

  el('channel').value=channel;

  el('onFeePct').value=ch.online.feePct; el('onPayPct').value=ch.online.payPct; el('onFixedPer').value=ch.online.fixedPer; el('onLogPer').value=ch.online.logPer; el('onSaaS').value=ch.online.saasM; el('onMgmt').value=ch.online.mgmtM;
  el('pvAuto').value=ch.piva.autoM; el('pvFixed').value=ch.piva.fixedM; el('pvPct').value=ch.piva.pct; el('pvTeleKm').value=ch.piva.teleKm; el('pvKm').value=ch.piva.kmM; el('pvKml').value=ch.piva.kml; el('pvFuel').value=ch.piva.fuel; el('pvOtherM').value=ch.piva.otherM;
  el('emRal').value=ch.employee.ralY; el('emAuto').value=ch.employee.autoM; el('emTele').value=ch.employee.teleM; el('emTrips').value=ch.employee.tripsM; el('emPct').value=ch.employee.pct; el('emKm').value=ch.employee.kmM; el('emKml').value=ch.employee.kml; el('emFuel').value=ch.employee.fuel;
}
function wire(){
  bind('price','input', ()=>{ our.p=+el('price').value; refreshEcho(); });
  bind('invQ','input',  ()=>{ our.Q=+el('invQ').value; refreshEcho(); });
  bind('invB','input',  ()=>{ our.B=+el('invB').value; refreshEcho(); });
  bind('invS','input',  ()=>{ our.S=+el('invS').value; refreshEcho(); });
  bind('cap','input',   ()=>{ cap=+el('cap').value; refreshEcho(); });

  bind('iva','change',  ()=>{ ivaIncl=el('iva').checked; refreshEcho(); });
  bind('ivaPct','input',()=>{ ivaPct=(+el('ivaPct').value||22)/100; refreshEcho(); });
  bind('beta','input',  ()=>{ beta=+el('beta').value||beta; refreshEcho(); });
  bind('season','input',()=>{ season=+el('season').value||season; refreshEcho(); });

  bind('buyCost','input', ()=>{ buyCost=+el('buyCost').value||buyCost; refreshEcho(); });
  bind('varOver','input', ()=>{ varOver=+el('varOver').value||varOver; refreshEcho(); });
  bind('minMarginPct','input', ()=>{ minMargin=+el('minMarginPct').value||minMargin; refreshEcho(); });
  bind('taxPct','input', ()=>{ tax=(+el('taxPct').value||24)/100; refreshEcho(); });

  bind('wTier','change', ()=>{ warranty.months=+el('wTier').value||warranty.months; refreshEcho(); });
  bind('wRateIn','input', ()=> refreshEcho());
  bind('wCostIn','input', ()=> refreshEcho());
  bind('wRateOut','input',()=> refreshEcho());
  bind('wCostOut','input',()=> refreshEcho());

  ['fxStaff','fxRent','fxSaaS','fxOther'].forEach(id=>bind(id,'input', ()=>{ 
    fixedBase={ staff:+el('fxStaff').value||0, rent:+el('fxRent').value||0, saas:+el('fxSaaS').value||0, other:+el('fxOther').value||0 }; 
    refreshEcho();
  }));

  bind('channel','change', ()=>{ channel=el('channel').value; showChannelPanels(); refreshEcho(); });
  ['onFeePct','onPayPct','onFixedPer','onLogPer','onSaaS','onMgmt','pvAuto','pvFixed','pvPct','pvTeleKm','pvKm','pvKml','pvFuel','pvOtherM','emRal','emAuto','emTele','emTrips','emPct','emKm','emKml','emFuel']
  .forEach(id=> bind(id,'input', ()=>{ 
    ch = {
      online:{feePct:+el('onFeePct').value||0,payPct:+el('onPayPct').value||0,fixedPer:+el('onFixedPer').value||0,logPer:+el('onLogPer').value||0,saasM:+el('onSaaS').value||0,mgmtM:+el('onMgmt').value||0},
      piva:{autoM:+el('pvAuto').value||0,fixedM:+el('pvFixed').value||0,pct:+el('pvPct').value||0,teleKm:+el('pvTeleKm').value||0,kmM:+el('pvKm').value||0,kml:+el('pvKml').value||1,fuel:+el('pvFuel').value||0,otherM:+el('pvOtherM').value||0},
      employee:{ralY:+el('emRal').value||0,autoM:+el('emAuto').value||0,teleM:+el('emTele').value||0,tripsM:+el('emTrips').value||0,pct:+el('emPct').value||0,kmM:+el('emKm').value||0,kml:+el('emKml').value||1,fuel:+el('emFuel').value||0}
    }; 
    showChannelPanels(); refreshEcho();
  }));

  bind('advance','click', ()=> simulateDay());
  bind('reset','click',   ()=>{ 
    if(!confirm('Nuova partita?')) return;
    localStorage.clear(); 
    const adv = el('advance'); if (adv){ adv.disabled=false; adv.textContent='Avanza giorno'; }
    location.reload(); 
  });

  // üí° Indica la soluzione (usa advisor, fallback a ricalcolo)
  document.getElementById('show-solution').addEventListener('click', () => {
    const box = document.getElementById('solution-box');
    if (!box) return;
    try {
      let bestP = window.lastAdvisorPrice;
      let bestProfit = null;

      if (bestP == null) {
        const market = Math.round(M * (1 + season/100));
        let best = our.p, bestProf = -Infinity;
        for (let p = 10; p <= 120; p += 0.5) {
          const s = shares([{...our, p}].concat(comps))[0];
          const q = Math.min(Math.round(s * market), cap);
          const pNet = ivaIncl ? p/(1+ivaPct) : p;
          const vc = buyCost + varOver + (8 + 2*our.Q) + wCostPerUnit() + channelVarPerUnit(pNet);
          const F  = fixedTotalPerDay();
          const pre  = Math.max(0, pNet - vc) * q - F;
          const post = pre > 0 ? pre * (1 - tax) : pre;
          if (post > bestProf) { bestProf = post; best = p; }
        }
        bestP = best; bestProfit = bestProf;
      }

      box.innerHTML = `üëâ Prezzo suggerito dal sistema: <b>${euro(bestP)}</b>${bestProfit!=null?`<br><small>Utile atteso: ${euro(bestProfit)}</small>`:''}`;
      box.style.display = 'block';
    } catch (e) {
      console.error('Advisor error:', e);
      box.innerHTML = '‚ö†Ô∏è Errore nel calcolo della soluzione.';
      box.style.display = 'block';
    }
  });
}

/* ====== Start ====== */
document.addEventListener('DOMContentLoaded', ()=>{
  hydrateInputs();
  showChannelPanels();
  refreshEcho();
  runAdvisor();
  wire();

  // Se rientriamo a G10, blocca subito il bottone
  if (day >= MAX_DAYS) {
    const adv = el('advance');
    if (adv) { adv.disabled = true; adv.textContent = 'Partita conclusa'; }
  }
});
</script>

</body>
</html>
