<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover,maximum-scale=1"/>
  <title>Margin Rush ‚Äî v4.9 Pro (MC ‚Ä¢ Copertura ‚Ä¢ Margine di sicurezza ‚Ä¢ BE)</title>
  <meta name="theme-color" content="#0b1220"/>
  <link rel="stylesheet" href="style.css">
</head>
<body>
<header>
  <h1>Margin Rush</h1>
  <div class="actions">
    <button id="advance">‚ñ∂Ô∏è Avanza giorno</button>
    <button id="reset">üîÑ Nuova partita</button>
    <button id="show-solution">üí° Indica la soluzione</button>
  </div>
  <div class="badges">
    Giorno <b id="day">1</b> ‚Äî
    Cassa <b id="cash">‚Ç¨5.000</b> ‚Äî
    Utile cumulato <b id="cumprofit">‚Ç¨0</b> ‚Äî
    Quota nostra <b id="share">0%</b>
  </div>
</header>

<main>
  <!-- ========== COLONNA SINISTRA: REPORT MERCATO ========== -->
  <div class="card">
    <h3>Mercato & Competitor</h3>
    <div class="section">
      <table id="tbl">
        <thead><tr><th>Player</th><th>Prezzo</th><th>Q</th><th>B</th><th>S</th><th>Quota</th><th>Unit√†</th></tr></thead>
        <tbody></tbody>
      </table>
    </div>
    <div id="log" class="log"></div>
  </div>

  <!-- ========== COLONNA DESTRA: LEVE & COSTI ========== -->
  <div class="card">
    <h3>Leve, costi, canali</h3>
    <div class="section">
      <!-- (CONTROLLI PRINCIPALI ecc. invariati, non li riscrivo qui per brevit√†) -->

      <div class="note" id="advisor" style="margin-top:8px">Advisor‚Ä¶</div>
      <div id="solution-box" class="box" style="display:none; margin-top:8px"></div>

      <!-- Grafici -->
      <canvas id="beChart" class="chart"></canvas>
      <canvas id="mcChart" class="chart"></canvas>
    </div>
  </div>

  <!-- REPORT -->
  <div class="card" style="margin-top:12px">
    <h3>Report del giorno</h3>
    <div class="section">
      <div class="kpi">
        <div class="box">Unit√† nostre: <b id="qMe">0</b></div>
        <div class="box">Quota nostra: <b id="sMe">0%</b></div>
        <div class="box">Utile netto: <b id="pMe">‚Ç¨0,00</b></div>
        <div class="box">Clienti spostati: <b id="moved">0</b></div>
      </div>
      <div class="kpi" style="margin-top:8px">
        <div class="box">MC/u<br><b id="kpiMcUnit">‚Ç¨0,00</b></div>
        <div class="box">MC totale oggi<br><b id="kpiMcTotal">‚Ç¨0,00</b></div>
        <div class="box">Indice di copertura<br><b id="kpiCover">0%</b></div>
        <div class="box">Margine di sicurezza<br><b id="kpiMoS">‚Äî</b></div>
      </div>
      <div class="note" style="margin-top:6px">
        Œî clienti ‚Äî Prezzo: <b id="bp">0</b> ¬∑ Q: <b id="bq">0</b> ¬∑ B: <b id="bb">0</b> ¬∑ S: <b id="bs">0</b>
      </div>
    </div>
  </div>
</main>

<!-- ======================= SCRIPT ======================= -->
<script src="app.js"></script>
<script>
// --- runAdvisor aggiornato ---
function runAdvisor(){
  const F = fixedTotalPerDay();
  const market = Math.round(M * (1 + season/100));
  let best = our.p;
  let bestProf = -Infinity;

  for (let p = 10; p <= 120; p += 0.5) {
    const s = shares([{...our, p}].concat(comps))[0];
    const q = Math.min(Math.round(s * market), cap);

    const pNet = netP(p);
    const vc = buyCost + varOver + costQ(our.Q) + wCostPerUnit() + channelVarPerUnit(pNet);

    const pre = Math.max(0, pNet - vc) * q - F;
    const post = pre > 0 ? pre * (1 - tax) : pre;

    if (post > bestProf) { bestProf = post; best = p; }
  }

  // salva anche in variabili globali
  window.lastAdvisorPrice = best;
  window.lastAdvisorProfit = bestProf;

  if (document.getElementById('advisor')) {
    document.getElementById('advisor').innerHTML =
      `Advisor: <b>${euro(best)}</b> ‚Äî utile atteso ${euro(bestProf)} (post-tax).`;
  }

  return { best, bestProf };
}

// --- wiring pulsante ---
function start(){
  document.getElementById('advance').onclick = simulateDay;
  document.getElementById('reset').onclick = ()=>location.reload();

  const btn = document.getElementById('show-solution');
  if (btn) btn.onclick = () => {
    const box = document.getElementById('solution-box'); if (!box) return;
    const price = (window.lastAdvisorPrice != null) ? window.lastAdvisorPrice : runAdvisor().best;
    const profit = (window.lastAdvisorProfit != null) ? window.lastAdvisorProfit : runAdvisor().bestProf;
    box.innerHTML = `üëâ Prezzo suggerito dal sistema: <b>${euro(price)}</b><br><small>Utile atteso: ${euro(profit)}</small>`;
    box.style.display = 'block';
  };
}

// avvia app
document.addEventListener('DOMContentLoaded', ()=>{ start(); });
</script>
</body>
</html>
