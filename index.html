<!doctype html>
<html lang="it">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover,maximum-scale=1"/>
<title>Margin Rush — v4.6 Pro (Acquisto, Margine minimo, Garanzia, BE chart)</title>
<meta name="theme-color" content="#0b1220"/>
<style>
:root{--bg:#0b1220;--card:#0f1930;--ink:#eaf0ff;--muted:#b9c7eb;--grid:#1f2d4f;--accent:#87a7ff;--good:#6be675;--bad:#ff7a88;--warn:#ffd166;}
*{box-sizing:border-box} html,body{margin:0;padding:0;background:var(--bg);color:var(--ink);font:16px/1.5 system-ui,-apple-system,Segoe UI,Roboto,Arial}
header{position:sticky;top:0;z-index:30;background:linear-gradient(180deg,rgba(11,18,32,.96),rgba(11,18,32,.82));backdrop-filter:blur(6px)}
.wrap{max-width:1200px;margin:0 auto;padding:14px}
h1{margin:0;font-size:1.25rem}.pill{display:inline-block;padding:2px 8px;border:1px solid var(--grid);border-radius:999px;background:#132046;color:#cfe}
.top{display:flex;gap:10px;align-items:center;flex-wrap:wrap;margin-top:6px}
.badge{padding:6px 10px;border:1px solid var(--grid);border-radius:10px;background:#0c1630;color:#c8d4f6;white-space:nowrap}
button{background:#1a2647;color:var(--ink);border:1px solid var(--grid);padding:10px 14px;border-radius:12px;cursor:pointer}
button.primary{background:var(--accent);color:#0a1025;border:none;font-weight:700}
button.danger{background:#ff5b6b;color:#0a1025;border:none;font-weight:700}
main{padding:14px}
.grid{display:grid;grid-template-columns:1.15fr 1fr;gap:14px;align-items:start}
.card{background:var(--card);border:1px solid var(--grid);border-radius:14px;overflow:hidden}
.card h3{margin:0;padding:10px;border-bottom:1px solid var(--grid)}
.section{padding:10px}
table{width:100%;border-collapse:collapse}
th,td{padding:8px;border-bottom:1px solid var(--grid);text-align:right;font-variant-numeric:tabular-nums}
th:first-child,td:first-child{text-align:left}
.kpi{display:grid;grid-template-columns:repeat(4,minmax(140px,1fr));gap:8px}
.kpi .box{padding:10px;border:1px solid var(--grid);border-radius:12px;background:#0c1530}
.note{color:#a9b6db;font-size:.92rem}
.warn{color:var(--warn)} .gain{color:var(--good)} .loss{color:#ffb0ba}
.log{max-height:220px;overflow:auto;border-top:1px solid var(--grid);background:#0c1630}
.log-item{display:flex;gap:8px;align-items:center;border-bottom:1px dashed #1e2a4e;padding:8px 10px}
.dot{width:8px;height:8px;border-radius:999px;background:var(--warn)}
.log-item .who{min-width:160px;color:#cfe}
.log-item .what{color:#dfe6ff}
.advisor{padding:8px 10px;border:1px dashed var(--grid);border-radius:10px;background:#0b1636;margin-top:8px}
.chart{width:100%;height:230px;background:#0b1432;border:1px solid var(--grid);border-radius:10px}
@media (max-width:1100px){.grid{grid-template-columns:1fr}.kpi{grid-template-columns:repeat(2,1fr)} .log-item .who{min-width:auto}}
@media (max-width:760px){html{font-size:15px} th,td{padding:7px} .badge{padding:5px 8px} button{padding:9px 12px}}
</style>
</head>
<body>
<header>
  <div class="wrap">
    <h1>Margin Rush <span class="pill">v4.6 Pro — Acquisto • Margine minimo • Garanzia • BE chart</span></h1>
    <div class="top">
      <div class="badge">Giorno: <b id="day">1</b>/10</div>
      <div class="badge">Cassa: <b id="cash">€5.000,00</b></div>
      <div class="badge">Quota oggi: <b id="share">0%</b></div>
      <div class="badge">Utile cumulato: <b id="cumprofit">€0,00</b></div>
      <button id="advance" class="primary">Avanza giorno</button>
      <button id="reset" class="danger">Nuova partita</button>
    </div>
  </div>
</header>

<main class="wrap">
  <div class="grid">
    <div class="card">
      <h3>Il mercato (noi vs 3 competitor)</h3>
      <div class="section">
        <div class="kpi">
          <div class="box">Mercato M: <b id="M">1200</b></div>
          <div class="box">Stagionalità: <b id="seasonEcho">+0%</b></div>
          <div class="box">β: <b id="betaEcho">0.080</b></div>
          <div class="box">Capienza: <b id="capEcho">1000</b></div>
        </div>
        <table id="tbl">
          <thead><tr><th>Offerta</th><th>Prezzo</th><th>Q</th><th>B</th><th>S</th><th>Quota</th><th>Unità</th></tr></thead>
          <tbody></tbody>
        </table>
      </div>
      <div class="log" id="log"></div>
    </div>

    <div class="card">
      <h3>Leve & Pianificazione</h3>
      <div class="section">
        <table>
          <tr><td>Prezzo nostro</td><td><input id="price" type="range" min="5" max="120" step="0.5"/></td><td><b id="priceEcho">€49,00</b></td></tr>
          <tr><td>Investi in Qualità (Q)</td><td><input id="invQ" type="range" min="0" max="3" step="1"/></td><td><b id="invQEcho">0</b></td></tr>
          <tr><td>Investi in Brand (B)</td><td><input id="invB" type="range" min="0" max="3" step="1"/></td><td><b id="invBEcho">0</b></td></tr>
          <tr><td>Investi in Servizio (S)</td><td><input id="invS" type="range" min="0" max="2" step="1"/></td><td><b id="invSEcho">0</b></td></tr>
          <tr><td>Capienza ordini/g</td><td><input id="cap" type="range" min="300" max="3000" step="50"/></td><td><b id="capVal">1000</b></td></tr>
        </table>

        <div class="note">Costi diretti base: 8 + 2·Q (qualità). Tutte le formule includono anche <b>acquisto</b>, <b>overhead variabile</b> e <b>garanzia attesa</b> per unità.</div>
        <hr style="border-color:#1f2d4f">

        <div class="kpi">
          <div class="box">IVA incl.? <input type="checkbox" id="iva" checked></div>
          <div class="box">IVA % <input type="number" id="ivaPct" value="22" step="0.1" style="width:70px"></div>
          <div class="box">β <input type="number" id="beta" value="0.08" step="0.005" style="width:80px"></div>
          <div class="box">Stag. % <input type="number" id="season" value="0" step="1" style="width:70px"></div>
        </div>

        <h4 style="margin:12px 0 6px">Costi variabili & vincoli prezzo</h4>
        <div class="kpi">
          <div class="box">Prezzo d’acquisto €/u<br><input type="number" id="buyCost" value="20" step="0.1" style="width:120px"></div>
          <div class="box">Overhead variabile €/u<br><input type="number" id="varOver" value="1.20" step="0.1" style="width:120px"></div>
          <div class="box">Margine minimo %<br><input type="number" id="minMarginPct" value="15" step="0.5" style="width:120px"></div>
          <div class="box">Avviso margine<br><b id="minMarginWarn">—</b></div>
        </div>

        <h4 style="margin:12px 0 6px">Garanzia & costo atteso per unità</h4>
        <div class="kpi">
          <div class="box">Livello garanzia<br>
            <select id="wTier" style="width:140px">
              <option value="12">Minima · 12 mesi</option>
              <option value="24" selected>Media · 24 mesi</option>
              <option value="36">Buona · 36 mesi</option>
              <option value="60">Ottima · 60 mesi</option>
            </select>
          </div>
          <div class="box">Incidenza in garanzia %<br><input type="number" id="wRateIn" value="3" step="0.1" style="width:120px"></div>
          <div class="box">Costo medio in garanzia €<br><input type="number" id="wCostIn" value="40" step="1" style="width:120px"></div>
          <div class="box">Goodwill fuori garanzia %<br><input type="number" id="wRateOut" value="1" step="0.1" style="width:120px"></div>
          <div class="box">Costo medio fuori garanzia €<br><input type="number" id="wCostOut" value="30" step="1" style="width:120px"></div>
        </div>
        <div class="kpi" style="margin-top:6px">
          <div class="box">Costo garanzia atteso €/u<br><b id="wCostPerUnit">€0,00</b></div>
          <div class="box">MC/u (con garanzia) <br><b id="mcUnit">€0,00</b></div>
          <div class="box">BE u/g (post-tax)<br><b id="beUnits">—</b></div>
          <div class="box">Inizi a guadagnare oltre<br><b id="gainAfter">—</b></div>
        </div>

        <h4 style="margin:12px 0 6px">Dati osservati (periodo)</h4>
        <div class="kpi">
          <div class="box">Unità vendute periodo<br><input type="number" id="obsUnits" value="1000" step="10" style="width:120px"></div>
          <div class="box">Interventi in garanzia (#/€)<br>
            <input type="number" id="obsInN" value="20" step="1" style="width:58px"> /
            <input type="number" id="obsInCost" value="800" step="10" style="width:70px">
          </div>
          <div class="box">Interventi fuori garanzia (#/€)<br>
            <input type="number" id="obsOutN" value="8" step="1" style="width:58px"> /
            <input type="number" id="obsOutCost" value="200" step="10" style="width:70px">
          </div>
          <div class="box">Scostamento atteso vs reale<br><b id="wDelta">—</b></div>
        </div>

        <div class="advisor" id="advisor">Advisor: in calcolo…</div>
        <div style="margin-top:10px">
          <canvas id="beChart" class="chart" width="600" height="230"></canvas>
          <div class="note">Chart: Ricavi vs Costi totali al prezzo corrente (post-tax). Punto di pareggio evidenziato.</div>
        </div>
      </div>
    </div>
  </div>

  <div class="card" style="margin-top:12px">
    <h3>Report del giorno</h3>
    <div class="section">
      <div class="kpi">
        <div class="box">Unità nostre: <b id="qMe">0</b></div>
        <div class="box">Quota nostra: <b id="sMe">0%</b></div>
        <div class="box">Utile netto: <b id="pMe">€0,00</b></div>
        <div class="box">Clienti spostati: <b id="moved">0</b></div>
      </div>
      <div class="note" style="margin-top:8px">
        Δ stimato (clienti) — Prezzo: <b id="bp">0</b> · Q: <b id="bq">0</b> · B: <b id="bb">0</b> · S: <b id="bs">0</b>
      </div>
    </div>
  </div>
</main>

<script>
/* Utils */
function $(id){return document.getElementById(id)}
const euro=n=>(Math.round(n*100)/100).toLocaleString('it-IT',{style:'currency',currency:'EUR'});
const clamp=(x,a,b)=>Math.max(a,Math.min(b,x));
function saveLS(k,v){try{localStorage.setItem(k,JSON.stringify(v));}catch(e){}}
function loadLS(k,d){try{const v=localStorage.getItem(k);return v?JSON.parse(v):d;}catch(e){return d}}

/* Stato base */
let day=1,M=1200,beta=0.08,season=0,ivaIncl=true,ivaPct=0.22,cap=1000;
let fixed = loadLS('mr_fixed',{staff:300,rent:120,saas:60,other:20});
let varOver = loadLS('mr_varOver',1.20);
let taxPct = loadLS('mr_taxPct',24)/100;
let buyCost = loadLS('mr_buyCost',20);
let minMarginPct = loadLS('mr_minMargin',15);
let cash=5000,cumProfit=0;

/* Offerte */
let our={name:"Noi",p:49,Q:1,B:1,S:1};
let comps=[
 {name:"Comp A (Price-war)",p:45,Q:1,B:1,S:1,strat:"price"},
 {name:"Comp B (Premium)",p:70,Q:2,B:2,S:2,strat:"premium"},
 {name:"Comp C (Bandit)",p:52,Q:1,B:1,S:1,strat:"bandit",
  actions:[{dp:-0.10,dQ:0,dB:0,dS:0,name:"Price −10%"},{dp:-0.05,dQ:0,dB:0,dS:0,name:"Price −5%"},{dp:0,dQ:1,dB:0,dS:0,name:"+Quality"},{dp:0,dQ:0,dB:1,dS:0,name:"+Brand"},{dp:+0.05,dQ:0,dB:0,dS:1,name:"+Service & +5%"}],
  Qvals:[0,0,0,0,0],N:[0,0,0,0,0],epsilon:0.25}
];

/* Log UI */
const logEl=$('log'); function pushLog(w,what){const d=document.createElement('div');d.className='log-item';d.innerHTML=`<span class="dot"></span><span class="who">${w}</span><span class="what">${what}</span>`;logEl.prepend(d);}

/* Domanda (logit) */
function shares(players){
  const U=players.map(o=>{
    const base=0.6+(o.B-1)*0.15+(o.Q-1)*0.2;
    const price=-beta*o.p;
    const q=0.25*(o.Q-1);
    const b=0.20*(o.B-1);
    const s=0.15*(o.S-1);
    const shock=(season/100)*(0.1+0.2*(o.B-1));
    return base+price+q+b+s+shock;
  });
  const mx=Math.max(...U); const exps=U.map(u=>Math.exp(u-mx)); const sum=exps.reduce((a,b)=>a+b,0);
  return exps.map(e=>e/sum);
}

/* Costi */
const costQ = Q => 8 + 2*Q;                 // qualità (diretti)
const netP  = p => ivaIncl? p/(1+ivaPct):p; // netto da IVA
function wCostPerUnit(){ // costo atteso garanzia/u
  const rateIn = (+$('wRateIn').value||0)/100;
  const rateOut= (+$('wRateOut').value||0)/100;
  const cIn  = (+$('wCostIn').value||0);
  const cOut = (+$('wCostOut').value||0);
  return rateIn*cIn + rateOut*cOut; // linearizzato
}
function varCostPerUnit(){ // totale variabile/u
  return buyCost + varOver + costQ(our.Q) + wCostPerUnit();
}
function mcUnit(){ // margine di contribuzione per unità
  return Math.max(0, netP(our.p) - varCostPerUnit());
}

/* BE post-tax + chart helpers */
function fixedTotal(){ return (+fxStaff.value||0)+(+fxRent.value||0)+(+fxSaaS.value||0)+(+fxOther.value||0); }
function bePostTax(){
  const mc = mcUnit(); const tau=(+taxPctInp.value||0)/100; const F=fixedTotal();
  if(mc<=0) return {units:Infinity, revenue:Infinity};
  const u = Math.ceil( F / (mc*(1 - tau)) );
  return {units:u, revenue: u * netP(our.p)};
}

/* Advisor (competitor fermi 1g) */
function runAdvisor(){
  const F=fixedTotal(), tau=(+taxPctInp.value||0)/100;
  let best=our.p, bestProf=-1;
  for(let p=10;p<=120;p+=0.5){
    const s=shares([{...our,p}].concat(comps))[0];
    const q=Math.min(Math.round(s*M*(1+season/100)),cap);
    const mc = Math.max(0, netP(p) - (buyCost + varOver + costQ(our.Q) + wCostPerUnit()));
    const profPre = mc*q - F;
    const prof = profPre>0 ? profPre*(1 - tau) : profPre;
    if(prof>bestProf){bestProf=prof; best=p;}
  }
  $('advisor').innerHTML=`Advisor: <b>${euro(best)}</b> — utile atteso ${euro(bestProf)} (post-tax).`;
}

/* Avviso margine minimo */
function checkMinMargin(){
  const pNet=netP(our.p);
  const gm = pNet>0 ? (pNet - varCostPerUnit())/pNet*100 : -Infinity; // gross margin %
  const warn = gm < (+$('minMarginPct').value||0);
  $('minMarginWarn').innerHTML = warn ? `<span class="warn">Sotto margine minimo (${gm.toFixed(1)}%)</span>` : '<span class="gain">OK</span>';
}

/* BE chart */
function drawChart(){
  const c=$('beChart'), ctx=c.getContext('2d');
  const w=c.clientWidth, h=c.clientHeight; if(c.width!==w){c.width=w;c.height=h;}
  ctx.clearRect(0,0,w,h);
  const pad=36; const maxQ=Math.max(cap, Math.round(M*(1+season/100)));
  const pNet=netP(our.p), vCost=varCostPerUnit(), F=fixedTotal(), tau=(+taxPctInp.value||0)/100;

  function x(q){return pad + (q/maxQ)*(w-pad*1.2);}
  function y(v){const maxV=Math.max(pNet*maxQ, (vCost*maxQ+F)/(1-tau)); return h-pad - (v/maxV)*(h-pad*1.2);}

  ctx.strokeStyle="#254"; ctx.lineWidth=1; ctx.beginPath(); ctx.moveTo(pad, y(0)); ctx.lineTo(w-pad*0.2, y(0)); ctx.moveTo(pad, y(0)); ctx.lineTo(pad, pad*0.2); ctx.stroke();

  ctx.strokeStyle="#7aa7ff"; ctx.lineWidth=2; ctx.beginPath(); ctx.moveTo(x(0), y(0)); ctx.lineTo(x(maxQ), y(pNet*maxQ)); ctx.stroke(); ctx.fillStyle="#7aa7ff"; ctx.fillText("Ricavi", x(maxQ)-50, y(pNet*maxQ)-6);

  const totAtQ = q => (vCost*q + F) / (1 - tau);
  ctx.strokeStyle="#ff7a88"; ctx.beginPath(); ctx.moveTo(x(0), y(totAtQ(0))); ctx.lineTo(x(maxQ), y(totAtQ(maxQ))); ctx.stroke(); ctx.fillStyle="#ff7a88"; ctx.fillText("Costi totali", x(maxQ)-80, y(totAtQ(maxQ))-6);

  const be = bePostTax(); 
  if(isFinite(be.units) && be.units<=maxQ){
    ctx.fillStyle="#6be675"; ctx.beginPath(); ctx.arc(x(be.units), y(pNet*be.units), 4, 0, Math.PI*2); ctx.fill();
    ctx.fillText(`BE: ${be.units} u`, x(be.units)+6, y(pNet*be.units)-6);
  }
}

/* Clienti spostati */
let prev = { p: our.p, Q: our.Q, B: our.B, S: our.S, share: 0, units: 0 };
function ourShareWith(cfg){ const meTmp={...our,...cfg}; return shares([meTmp].concat(comps))[0]; }
function estimateMovedAndBreakdown(marketToday){
  const s_prev = prev.share || ourShareWith({ p: prev.p, Q: prev.Q, B: prev.B, S: prev.S });
  const s_now  = ourShareWith({ p: our.p, Q: our.Q, B: our.B, S: our.S });
  const moved = Math.round((s_now - s_prev) * marketToday);
  const s_p = ourShareWith({ p: our.p,   Q: prev.Q, B: prev.B, S: prev.S });
  const s_q = ourShareWith({ p: our.p,   Q: our.Q,  B: prev.B, S: prev.S });
  const s_b = ourShareWith({ p: our.p,   Q: our.Q,  B: our.B,  S: prev.S });
  const d_price = Math.round((s_p - s_prev) * marketToday);
  const d_q     = Math.round((s_q - s_p)    * marketToday);
  const d_b     = Math.round((s_b - s_q)    * marketToday);
  const d_s     = Math.round((s_now - s_b)  * marketToday);
  return { moved, d_price, d_q, d_b, d_s, s_now };
}

/* Simulazione giorno */
function simulateDay(){
  const F=fixedTotal(), tau=(+taxPctInp.value||0)/100;
  const s=shares([our].concat(comps));
  const marketToday=Math.round(M*(1+season/100));
  const q=s.map(x=>Math.round(x*marketToday));
  q[0]=Math.min(q[0],cap);

  const { moved, d_price, d_q, d_b, d_s, s_now } = estimateMovedAndBreakdown(marketToday);

  const rev=netP(our.p)*q[0];
  const cost=varCostPerUnit()*q[0];
  let profitPre = rev - cost - F;
  let profit    = profitPre>0 ? profitPre*(1 - tau) : profitPre;

  cash+=profit; cumProfit+=profit;

  renderTable(q,s);
  $('qMe').textContent=q[0].toLocaleString('it-IT');
  $('sMe').textContent=(s[0]*100).toFixed(1)+'%';
  $('pMe').textContent=euro(profit);
  $('cash').textContent=euro(cash);
  $('cumprofit').textContent=euro(cumProfit);
  $('share').textContent=(s[0]*100).toFixed(1)+'%';

  $('moved').textContent = (moved>=0?'+':'') + moved.toLocaleString('it-IT');
  $('bp').textContent = (d_price>=0?'+':'') + d_price.toLocaleString('it-IT');
  $('bq').textContent = (d_q>=0?'+':'') + d_q.toLocaleString('it-IT');
  $('bb').textContent = (d_b>=0?'+':'') + d_b.toLocaleString('it-IT');
  $('bs').textContent = (d_s>=0?'+':'') + d_s.toLocaleString('it-IT');

  prev = { p: our.p, Q: our.Q, B: our.B, S: our.S, share: s_now, units: q[0] };

  // “inizia a guadagnare oltre…”
  const be = bePostTax();
  $('gainAfter').textContent = isFinite(be.units) ? `${be.units.toLocaleString('it-IT')} u/g` : '—';
}

/* Tabella */
function renderTable(q=null,s=null){
  const rows=[our].concat(comps).map((p,i)=>{
    const quota=s?(s[i]*100).toFixed(1)+'%':'—', units=q?q[i].toLocaleString('it-IT'):'—';
    return `<tr><td>${i===0?'Noi':p.name}</td><td>${euro(p.p)}</td><td>${p.Q}</td><td>${p.B}</td><td>${p.S}</td><td>${quota}</td><td>${units}</td></tr>`;
  }).join(''); document.querySelector('#tbl tbody').innerHTML=rows;
}

/* BE chart & echo */
function refreshEcho(){
  $('priceEcho').textContent=euro(our.p);
  $('betaEcho').textContent=beta.toFixed(3);
  $('seasonEcho').textContent=(season>=0?'+':'')+season+'%';
  $('capEcho').textContent=cap; $('capVal').textContent=cap;
  $('cash').textContent=euro(cash); $('cumprofit').textContent=euro(cumProfit);

  fixed={staff:+fxStaff.value||0, rent:+fxRent.value||0, saas:+fxSaaS.value||0, other:+fxOther.value||0};
  varOver=+varOverInp.value||0; taxPct=(+taxPctInp.value||0)/100; buyCost=+buyCostInp.value||0; minMarginPct=+minMarginInp.value||0;
  saveLS('mr_fixed',fixed); saveLS('mr_varOver',varOver); saveLS('mr_taxPct',(+taxPctInp.value||0)); saveLS('mr_buyCost',buyCost); saveLS('mr_minMargin',minMarginPct);

  $('wCostPerUnit').textContent = euro(wCostPerUnit());
  $('mcUnit').textContent = euro(mcUnit());
  const be = bePostTax();
  $('beUnits').textContent = isFinite(be.units) ? be.units.toLocaleString('it-IT') : '— (margine ≤ 0)';
  checkMinMargin(); runAdvisor(); drawChart();
  // scostamento atteso vs reale (periodo)
  const expected = (wCostPerUnit() * (+$('obsUnits').value||0));
  const actual   = (+$('obsInCost').value||0) + (+$('obsOutCost').value||0);
  const delta    = actual - expected;
  $('wDelta').innerHTML = (delta>=0?'<span class="loss">+':'<span class="gain">') + euro(delta) + '</span>';
}

/* DOM refs & init */
const fxStaff=$('fxStaff'), fxRent=$('fxRent'), fxSaaS=$('fxSaaS'), fxOther=$('fxOther');
const varOverInp=$('varOver'), taxPctInp=$('taxPct'), buyCostInp=$('buyCost'), minMarginInp=$('minMarginPct');

fxStaff.value=fixed.staff; fxRent.value=fixed.rent; fxSaaS.value=fixed.saas; fxOther.value=fixed.other;
varOverInp.value=Number(varOver).toFixed(2); taxPctInp.value=(taxPct*100).toFixed(1);
buyCostInp.value=buyCost; minMarginInp.value=minMarginPct;

$('price').value=our.p; $('cap').value=cap;
$('price').oninput=()=>{ our.p=parseFloat($('price').value); refreshEcho(); };
$('invQ').oninput=()=>{ $('invQEcho').textContent=$('invQ').value; };
$('invB').oninput=()=>{ $('invBEcho').textContent=$('invB').value; };
$('invS').oninput=()=>{ $('invSEcho').textContent=$('invS').value; };
$('cap').oninput=()=>{ cap=parseInt($('cap').value,10); refreshEcho(); };
$('beta').oninput=()=>{ beta=parseFloat($('beta').value)||0.08; refreshEcho(); };
$('season').oninput=()=>{ season=parseInt($('season').value||'0',10); refreshEcho(); };
$('iva').oninput=()=>{ ivaIncl=$('iva').checked; refreshEcho(); };
$('ivaPct').oninput=()=>{ ivaPct=parseFloat($('ivaPct').value)/100; refreshEcho(); };

[fxStaff,fxRent,fxSaaS,fxOther,varOverInp,taxPctInp,buyCostInp,minMarginInp,
 $('wTier'),$('wRateIn'),$('wCostIn'),$('wRateOut'),$('wCostOut'),
 $('obsUnits'),$('obsInN'),$('obsInCost'),$('obsOutN'),$('obsOutCost')
].forEach(el=>el.addEventListener('input',refreshEcho));

$('advance').onclick=()=>{
  // investimenti semplici (immediati)
  const iQ=parseInt($('invQ').value||'0',10), iB=parseInt($('invB').value||'0',10), iS=parseInt($('invS').value||'0',10);
  let invest = iQ*300 + iB*250 + iS*200;
  if(invest>0 && invest>cash){ alert('Cassa insufficiente per gli investimenti.'); return; }
  if(iQ>0){ our.Q += iQ*0.5; $('invQ').value=0; $('invQEcho').textContent=0; pushLog('Noi',`Quality +${iQ*0.5}`); }
  if(iB>0){ our.B += iB*0.5; $('invB').value=0; $('invBEcho').textContent=0; pushLog('Noi',`Brand +${iB*0.5}`); }
  if(iS>0){ our.S += iS; $('invS').value=0; $('invSEcho').textContent=0; pushLog('Noi',`Service +${iS}`); }
  if(invest>0){ cash-= (iQ*300 + iB*250 + iS*200); }

  comps.forEach(c=>{
    if(c.strat==='price'){ const t=Math.max(12,our.p*0.95); const prev=c.p; c.p=clamp(c.p*0.6+t*0.4,10,120); pushLog(c.name,`prezzo ${euro(prev)} → ${euro(c.p)}`); }
    else if(c.strat==='premium'){ let w=[]; if(day%2===0 && Math.random()<0.6){c.B=Math.min(5,c.B+1);w.push("+Brand");} else if(Math.random()<0.5){c.Q=Math.min(5,c.Q+1);w.push("+Quality");} const prev=c.p; c.p=clamp(c.p*1.01,30,140); pushLog(c.name,`${w.join(" ")} · prezzo ${euro(prev)} → ${euro(c.p)}`); }
    else { // bandit
      const before=shares([our].concat(comps))[3]; const acts=c.actions; const pick= (Math.random()<c.epsilon)? Math.floor(Math.random()*acts.length) : acts.map((_,i)=>i).reduce((b,i)=>c.Qvals[i]>c.Qvals[b]?i:b,0);
      const a=acts[pick]; const prev={p:c.p,Q:c.Q,B:c.B,S:c.S};
      c.p=clamp(c.p*(1+a.dp),10,140); if(a.dQ)c.Q=Math.min(5,c.Q+a.dQ); if(a.dB)c.B=Math.min(5,c.B+a.dB); if(a.dS)c.S=Math.min(5,c.S+a.dS);
      const after=shares([our].concat(comps))[3]; c.N[pick]++; c.Qvals[pick]+= (after-before - c.Qvals[pick]) / c.N[pick]; c.epsilon=Math.max(0.05,c.epsilon*0.98);
      pushLog(c.name,`${a.name} · ${euro(prev.p)} → ${euro(c.p)} · Q${prev.Q}→${c.Q} · B${prev.B}→${c.B} · S${prev.S}→${c.S}`);
    }
  });

  simulateDay();
  day++; $('day').textContent=day;
  if(day>10){ alert('Fine partita — utile cumulato: '+$('cumprofit').textContent); location.reload(); }
  refreshEcho();
};

$('reset').onclick=()=>location.reload();

/* Start */
const fxStaff=$('fxStaff'), fxRent=$('fxRent'), fxSaaS=$('fxSaaS'), fxOther=$('fxOther');
refreshEcho(); renderTable(); runAdvisor(); drawChart();
</script>
</body>
</html>
