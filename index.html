<!doctype html>
<html lang="it">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover,maximum-scale=1"/>
<title>Margin Rush — v4.7-min Pro (Canale vendita + BE)</title>
<meta name="theme-color" content="#0b1220"/>
<style>
:root{--bg:#0b1220;--card:#0f1930;--ink:#eaf0ff;--muted:#b9c7eb;--grid:#1f2d4f;--accent:#87a7ff;--good:#6be675;--bad:#ff7a88;--warn:#ffd166}
*{box-sizing:border-box}html,body{margin:0;background:var(--bg);color:var(--ink);font:15.5px/1.5 system-ui,-apple-system,Segoe UI,Roboto}
header{position:sticky;top:0;z-index:5;background:linear-gradient(#0b1220ee,#0b1220cc);backdrop-filter:blur(6px)}
.wrap{max-width:1150px;margin:0 auto;padding:14px}
h1{margin:0;font-size:1.2rem}.pill{padding:2px 8px;border:1px solid var(--grid);border-radius:999px;background:#14224a}
.badge{display:inline-block;margin:6px 6px 0 0;padding:6px 10px;border:1px solid var(--grid);border-radius:10px;background:#0c1630}
button{background:#1a2647;color:var(--ink);border:1px solid var(--grid);padding:9px 12px;border-radius:10px;cursor:pointer}
button.primary{background:var(--accent);color:#0b1220;border:none;font-weight:700}
.grid{display:grid;gap:12px;grid-template-columns:1.1fr 1fr}
.card{background:var(--card);border:1px solid var(--grid);border-radius:14px;overflow:hidden}
.card h3{margin:0;padding:10px;border-bottom:1px solid var(--grid)}
.section{padding:10px}
.kpi{display:grid;gap:8px;grid-template-columns:repeat(4,minmax(140px,1fr))}
.kpi .box{padding:10px;border:1px solid var(--grid);border-radius:12px;background:#0c1530}
table{width:100%;border-collapse:collapse}
th,td{padding:7px;border-bottom:1px solid var(--grid);text-align:right;font-variant-numeric:tabular-nums}
th:first-child,td:first-child{text-align:left}
.note{color:#a9b6db}.gain{color:var(--good)}.warn{color:var(--warn)}
.log{max-height:210px;overflow:auto;border-top:1px solid var(--grid);background:#0c1630}
.log-item{display:flex;gap:8px;border-bottom:1px dashed #1f2d4f;padding:7px 10px}
.chart{width:100%;height:210px;background:#0b1432;border:1px solid var(--grid);border-radius:10px}
fieldset{border:1px solid var(--grid);border-radius:12px;padding:8px;margin-top:8px}
legend{padding:0 6px}
@media(max-width:1024px){.grid{grid-template-columns:1fr}.kpi{grid-template-columns:repeat(2,1fr)}}
</style>
</head>
<body>
<header>
  <div class="wrap">
    <h1>Margin Rush <span class="pill">v4.7-min — Canale vendita • Garanzia • BE</span></h1>
    <span class="badge">Giorno: <b id="day">1</b>/10</span>
    <span class="badge">Cassa: <b id="cash">€5.000,00</b></span>
    <span class="badge">Quota oggi: <b id="share">0%</b></span>
    <span class="badge">Utile cumulato: <b id="cumprofit">€0,00</b></span>
    <button id="advance" class="primary">Avanza giorno</button>
    <button id="reset">Nuova partita</button>
  </div>
</header>

<main class="wrap">
  <div class="grid">
    <div class="card">
      <h3>Il mercato (noi vs 3 competitor)</h3>
      <div class="section">
        <div class="kpi">
          <div class="box">Mercato M: <b id="M">1200</b></div>
          <div class="box">Stagionalità: <b id="seasonEcho">+0%</b></div>
          <div class="box">β: <b id="betaEcho">0.080</b></div>
          <div class="box">Capienza: <b id="capEcho">1000</b></div>
        </div>
        <table id="tbl"><thead><tr><th>Offerta</th><th>Prezzo</th><th>Q</th><th>B</th><th>S</th><th>Quota</th><th>Unità</th></tr></thead><tbody></tbody></table>
      </div>
      <div class="log" id="log"></div>
    </div>

    <div class="card">
      <h3>Leve, costi e canale</h3>
      <div class="section">
        <table>
          <tr><td>Prezzo nostro</td><td><input id="price" type="range" min="5" max="120" step="0.5"></td><td><b id="priceEcho">€49,00</b></td></tr>
          <tr><td>Q</td><td><input id="invQ" type="range" min="0" max="3" step="1"></td><td><b id="invQEcho">0</b></td></tr>
          <tr><td>B</td><td><input id="invB" type="range" min="0" max="3" step="1"></td><td><b id="invBEcho">0</b></td></tr>
          <tr><td>S</td><td><input id="invS" type="range" min="0" max="2" step="1"></td><td><b id="invSEcho">0</b></td></tr>
          <tr><td>Capienza ordini/g</td><td><input id="cap" type="range" min="300" max="3000" step="50"></td><td><b id="capVal">1000</b></td></tr>
        </table>

        <div class="kpi" style="margin-top:6px">
          <div class="box">IVA incl.? <input type="checkbox" id="iva" checked></div>
          <div class="box">IVA % <input type="number" id="ivaPct" value="22" step="0.1" style="width:70px"></div>
          <div class="box">β <input type="number" id="beta" value="0.08" step="0.005" style="width:80px"></div>
          <div class="box">Stag. % <input type="number" id="season" value="0" step="1" style="width:70px"></div>
        </div>

        <div class="kpi" style="margin-top:6px">
          <div class="box">Acquisto €/u<br><input type="number" id="buyCost" value="20" step="0.1" style="width:120px"></div>
          <div class="box">Overhead €/u<br><input type="number" id="varOver" value="1.2" step="0.1" style="width:120px"></div>
          <div class="box">Margine min %<br><input type="number" id="minMarginPct" value="15" step="0.5" style="width:120px"></div>
          <div class="box">Stato margine<br><b id="minMarginWarn">—</b></div>
        </div>

        <fieldset>
          <legend>Garanzia</legend>
          <div class="kpi">
            <div class="box">Livello (mesi)<br><select id="wTier" style="width:120px">
              <option value="12">12</option><option value="24" selected>24</option><option value="36">36</option><option value="60">60</option>
            </select></div>
            <div class="box">In garanzia %<br><input type="number" id="wRateIn" value="3" step="0.1" style="width:120px"></div>
            <div class="box">Costo in garanzia €<br><input type="number" id="wCostIn" value="40" step="1" style="width:120px"></div>
            <div class="box">Goodwill % / €<br>
              <input type="number" id="wRateOut" value="1" step="0.1" style="width:55px"> /
              <input type="number" id="wCostOut" value="30" step="1" style="width:55px">
            </div>
          </div>
          <div class="kpi">
            <div class="box">Costo garanzia/u<br><b id="wCostPerUnit">€0,00</b></div>
            <div class="box">MC/u (tutto incluso)<br><b id="mcUnit">€0,00</b></div>
            <div class="box">BE u/g (post-tax)<br><b id="beUnits">—</b></div>
            <div class="box">Oltre BE inizi a guadagnare<br><b id="gainAfter">—</b></div>
          </div>
        </fieldset>

        <fieldset>
          <legend>Canale vendita</legend>
          <div class="kpi">
            <div class="box">Canale<br>
              <select id="channel" style="width:160px">
                <option value="online" selected>Vendita on-line</option>
                <option value="piva">Venditore a P.IVA</option>
                <option value="employee">Dipendente</option>
              </select>
            </div>
            <div class="box">Fissi canale/g<br><b id="chFixedEcho">€0,00</b></div>
            <div class="box">Variabile canale/u<br><b id="chVarEcho">€0,00</b></div>
            <div class="box">Comm. % su netto<br><b id="chPctEcho">0%</b></div>
          </div>

          <!-- ONLINE -->
          <div id="ch-online">
            <div class="kpi">
              <div class="box">Fee piattaforma %<br><input type="number" id="onFeePct" value="6" step="0.1" style="width:120px"></div>
              <div class="box">Fee pagamento %<br><input type="number" id="onPayPct" value="2.5" step="0.1" style="width:120px"></div>
              <div class="box">Fee fissa ordine €<br><input type="number" id="onFixedPer" value="0.35" step="0.05" style="width:120px"></div>
              <div class="box">Logistica €/u<br><input type="number" id="onLogPer" value="3" step="0.1" style="width:120px"></div>
            </div>
            <div class="kpi"><div class="box">SaaS €/mese<br><input type="number" id="onSaaS" value="100" step="5" style="width:120px"></div></div>
          </div>

          <!-- P.IVA -->
          <div id="ch-piva" style="display:none">
            <div class="kpi">
              <div class="box">Auto €/mese<br><input type="number" id="pvAuto" value="400" step="10" style="width:120px"></div>
              <div class="box">Compenso fisso €/mese<br><input type="number" id="pvFixed" value="2000" step="50" style="width:120px"></div>
              <div class="box">Provvigione %<br><input type="number" id="pvPct" value="10" step="0.5" style="width:120px"></div>
              <div class="box">Telepass €/mese<br><input type="number" id="pvTele" value="30" step="1" style="width:120px"></div>
            </div>
            <div class="kpi">
              <div class="box">Km/mese<br><input type="number" id="pvKm" value="4000" step="100" style="width:120px"></div>
              <div class="box">Consumo km/l<br><input type="number" id="pvKml" value="18" step="0.1" style="width:120px"></div>
              <div class="box">Carburante €/l<br><input type="number" id="pvFuel" value="1.70" step="0.01" style="width:120px"></div>
            </div>
          </div>

          <!-- DIPENDENTE -->
          <div id="ch-employee" style="display:none">
            <div class="kpi">
              <div class="box">RAL annua €<br><input type="number" id="emRal" value="50000" step="500" style="width:120px"></div>
              <div class="box">Auto aziendale €/mese<br><input type="number" id="emAuto" value="450" step="10" style="width:120px"></div>
              <div class="box">Telepass €/mese<br><input type="number" id="emTele" value="30" step="1" style="width:120px"></div>
              <div class="box">Trasferte €/mese<br><input type="number" id="emTrips" value="250" step="10" style="width:120px"></div>
            </div>
            <div class="kpi">
              <div class="box">Provvigione % (opz.)<br><input type="number" id="emPct" value="0" step="0.5" style="width:120px"></div>
            </div>
          </div>
        </fieldset>

        <div class="note" id="advisor">Advisor: …</div>
        <canvas id="beChart" class="chart" width="600" height="210"></canvas>
      </div>
    </div>
  </div>

  <div class="card" style="margin-top:12px">
    <h3>Report del giorno</h3>
    <div class="section">
      <div class="kpi">
        <div class="box">Unità nostre: <b id="qMe">0</b></div>
        <div class="box">Quota nostra: <b id="sMe">0%</b></div>
        <div class="box">Utile netto: <b id="pMe">€0,00</b></div>
        <div class="box">Clienti spostati: <b id="moved">0</b></div>
      </div>
      <div class="note" style="margin-top:6px">Δ (clienti) — Prezzo: <b id="bp">0</b> · Q: <b id="bq">0</b> · B: <b id="bb">0</b> · S: <b id="bs">0</b></div>
    </div>
  </div>
</main>

<script>
/* Utils */
const $=id=>document.getElementById(id);
const euro=n=>(Math.round(n*100)/100).toLocaleString('it-IT',{style:'currency',currency:'EUR'});
const clamp=(x,a,b)=>Math.max(a,Math.min(b,x));
const save=(k,v)=>{try{localStorage.setItem(k,JSON.stringify(v));}catch{}};
const load=(k,d)=>{try{const v=localStorage.getItem(k);return v?JSON.parse(v):d;}catch{ return d; }};

/* Stato base */
let day=1,M=1200,beta=0.08,season=0,ivaIncl=true,ivaPct=0.22,cap=1000;
let cash=5000,cumProfit=0;
let buyCost=load('buyCost',20), varOver=load('varOver',1.2), minMarginPct=load('minMarginPct',15);
let fixedBase=load('fixedBase',{staff:300,rent:120,saas:60,other:20}); // per compatibilità eventuale
// canale
let channel=load('channel','online');
let ch=load('chParams',{
  online:{feePct:6,payPct:2.5,fixedPer:0.35,logPer:3,saasM:100},
  piva:{autoM:400,fixedM:2000,pct:10,teleM:30,kmM:4000,kml:18,fuel:1.7},
  employee:{ralY:50000,autoM:450,teleM:30,tripsM:250,pct:0}
});

/* Offerte e logit */
let our={name:"Noi",p:49,Q:1,B:1,S:1};
let comps=[
 {name:"Comp A (Price-war)",p:45,Q:1,B:1,S:1,strat:"price"},
 {name:"Comp B (Premium)",p:70,Q:2,B:2,S:2,strat:"premium"},
 {name:"Comp C (Bandit)",p:52,Q:1,B:1,S:1,strat:"bandit",Qvals:[0,0,0,0,0],N:[0,0,0,0,0],epsilon:0.25,
  actions:[{dp:-.1,name:"Price −10%"},{dp:-.05,name:"Price −5%"},{dQ:1,name:"+Q"},{dB:1,name:"+B"},{dS:1,dp:+.05,name:"+S & +5%"}]}];

const logEl=$('log'); const pushLog=(w,t)=>{const d=document.createElement('div');d.className='log-item';d.textContent=`${w}: ${t}`;logEl.prepend(d);};

function shares(players){
  const U=players.map(o=>{
    const base=0.6+(o.B-1)*.15+(o.Q-1)*.2, price=-beta*o.p, q=.25*(o.Q-1), b=.20*(o.B-1), s=.15*(o.S-1), shock=(season/100)*(0.1+0.2*(o.B-1));
    return base+price+q+b+s+shock;
  });
  const mx=Math.max(...U); const exps=U.map(u=>Math.exp(u-mx)); const sum=exps.reduce((a,b)=>a+b,0);
  return exps.map(e=>e/sum);
}
const costQ=Q=>8+2*Q;
const netP=p=>ivaIncl?p/(1+ivaPct):p;

/* Garanzia */
const wCostPerUnit=()=>((+wRateIn.value||0)/100*(+wCostIn.value||0))+((+wRateOut.value||0)/100*(+wCostOut.value||0));

/* Canale: fissi/giorno e variabile/u (su prezzo netto) */
function channelFixedPerDay(){
  if(channel==='online'){ return (+onSaaS.value||0)/30; }
  if(channel==='piva'){
    const km=+pvKm.value||0, fuel=+pvFuel.value||0, kml=+pvKml.value||1;
    const fuelM = km/kml*fuel;
    return ((+pvAuto.value||0)+(+pvFixed.value||0)+(+pvTele.value||0)+fuelM)/30;
  }
  // employee
  return ((+emRal.value||0)/12 + (+emAuto.value||0)+(+emTele.value||0)+(+emTrips.value||0))/30;
}
function channelVarPerUnit(pNet){
  if(channel==='online'){
    const pct=((+onFeePct.value||0)+(+onPayPct.value||0))/100;
    return pNet*pct + (+onFixedPer.value||0) + (+onLogPer.value||0);
  }
  if(channel==='piva'){
    const pct=(+pvPct.value||0)/100;
    return pNet*pct; // il resto è fisso
  }
  // employee
  const pct=(+emPct.value||0)/100;
  return pNet*pct;
}
function channelPctEcho(){
  if(channel==='online'){ return ((+onFeePct.value||0)+(+onPayPct.value||0)).toFixed(1)+'%'; }
  if(channel==='piva'){ return ((+pvPct.value||0)).toFixed(1)+'%'; }
  return ((+emPct.value||0)).toFixed(1)+'%';
}

/* Variabile/u totale e MC/u */
function varCostPerUnit(){
  const pNet=netP(our.p);
  return buyCost + varOver + costQ(our.Q) + wCostPerUnit() + channelVarPerUnit(pNet);
}
function mcUnit(){ return Math.max(0, netP(our.p) - varCostPerUnit()); }

/* Fissi totali/g */
function fixedTotal(){ return channelFixedPerDay(); }

/* BE post-tax */
function bePostTax(){
  const mc=mcUnit(), tau=(+taxPct.value||24)/100, F=fixedTotal();
  if(mc<=0) return {units:Infinity,revenue:Infinity};
  const u=Math.ceil(F/(mc*(1-tau))); return {units:u,revenue:u*netP(our.p)};
}

/* Advisor (competitor fermi 1g) */
function runAdvisor(){
  const tau=(+taxPct.value||24)/100, F=fixedTotal(); let best=our.p, bestP=-1;
  for(let p=10;p<=120;p+=.5){
    const s=shares([{...our,p}].concat(comps))[0];
    const q=Math.min(Math.round(s*M*(1+season/100)),cap);
    const pNet=netP(p);
    const vc = buyCost + varOver + costQ(our.Q) + wCostPerUnit() + channelVarPerUnit(pNet);
    const pre = Math.max(0,pNet-vc)*q - F; const post = pre>0 ? pre*(1-tau) : pre;
    if(post>bestP){bestP=post;best=p;}
  }
  advisor.innerHTML=`Advisor: <b>${euro(best)}</b> — utile atteso ${euro(bestP)} (post-tax).`;
}

/* Chart BE */
function drawChart(){
  const c=$('beChart'),ctx=c.getContext('2d'); const w=c.clientWidth,h=c.clientHeight; if(c.width!==w){c.width=w;c.height=h}
  ctx.clearRect(0,0,w,h);
  const pad=30,maxQ=Math.max(cap,Math.round(M*(1+season/100)));
  const pNet=netP(our.p), v=varCostPerUnit(), F=fixedTotal(), tau=(+taxPct.value||24)/100;
  const x=q=>pad+(q/maxQ)*(w-pad*1.2), y=v0=>{const maxV=Math.max(pNet*maxQ,(v*maxQ+F)/(1-tau));return h-pad-(v0/maxV)*(h-pad*1.2)};
  ctx.strokeStyle="#254";ctx.beginPath();ctx.moveTo(pad,y(0));ctx.lineTo(w-pad*.2,y(0));ctx.moveTo(pad,y(0));ctx.lineTo(pad,pad*.3);ctx.stroke();
  ctx.strokeStyle="#7aa7ff";ctx.beginPath();ctx.moveTo(x(0),y(0));ctx.lineTo(x(maxQ),y(pNet*maxQ));ctx.stroke();
  const tot=q=>(v*q+F)/(1-tau); ctx.strokeStyle="#ff7a88";ctx.beginPath();ctx.moveTo(x(0),y(tot(0)));ctx.lineTo(x(maxQ),y(tot(maxQ)));ctx.stroke();
  const be=bePostTax(); if(isFinite(be.units)&&be.units<=maxQ){ctx.fillStyle="#6be675";ctx.beginPath();ctx.arc(x(be.units),y(pNet*be.units),4,0,6.28);ctx.fill();}
}

/* Clienti spostati */
let prev={p:our.p,Q:our.Q,B:our.B,S:our.S,share:0,units:0};
const ourShareWith=cfg=>shares([{...our,...cfg}].concat(comps))[0];
function estimateMoved(marketToday){
  const s_prev=prev.share||ourShareWith(prev), s_now=ourShareWith(our);
  const s_p=ourShareWith({p:our.p,Q:prev.Q,B:prev.B,S:prev.S});
  const s_q=ourShareWith({p:our.p,Q:our.Q,B:prev.B,S:prev.S});
  const s_b=ourShareWith({p:our.p,Q:our.Q,B:our.B,S:prev.S});
  const moved=Math.round((s_now-s_prev)*marketToday);
  return {moved,dp:Math.round((s_p-s_prev)*marketToday),dq:Math.round((s_q-s_p)*marketToday),db:Math.round((s_b-s_q)*marketToday),ds:Math.round((s_now-s_b)*marketToday),s_now};
}

/* Simulazione giorno */
function renderTable(q=null,s=null){
  const rows=[our].concat(comps).map((p,i)=>`<tr><td>${i?p.name:'Noi'}</td><td>${euro(p.p)}</td><td>${p.Q}</td><td>${p.B}</td><td>${p.S}</td><td>${s? (s[i]*100).toFixed(1)+'%':'—'}</td><td>${q? q[i].toLocaleString('it-IT'):'—'}</td></tr>`).join('');
  $('#tbl tbody').innerHTML=rows;
}
function simulateDay(){
  const s=shares([our].concat(comps));
  const market=Math.round(M*(1+season/100));
  const q=s.map(x=>Math.round(x*market)); q[0]=Math.min(q[0],cap);
  const {moved,dp,dq,db,ds,s_now}=estimateMoved(market);
  const pNet=netP(our.p); const vc=varCostPerUnit(); const F=fixedTotal(); const tau=(+taxPct.value||24)/100;
  let profitPre=(pNet-vc)*q[0]-F; let profit=profitPre>0?profitPre*(1-tau):profitPre;
  cash+=profit; cumProfit+=profit;

  renderTable(q,s);
  qMe.textContent=q[0].toLocaleString('it-IT'); sMe.textContent=(s[0]*100).toFixed(1)+'%';
  pMe.textContent=euro(profit); cashEl.textContent=euro(cash); cumprofit.textContent=euro(cumProfit); share.textContent=(s[0]*100).toFixed(1)+'%';
  movedEl.textContent=(moved>=0?'+':'')+moved.toLocaleString('it-IT'); bp.textContent=(dp>=0?'+':'')+dp; bq.textContent=(dq>=0?'+':'')+dq; bb.textContent=(db>=0?'+':'')+db; bs.textContent=(ds>=0?'+':'')+ds;
  prev={p:our.p,Q:our.Q,B:our.B,S:our.S,share:s_now,units:q[0]};
  const be=bePostTax(); gainAfter.textContent=isFinite(be.units)?be.units.toLocaleString('it-IT')+' u/g':'—';
}

/* Echo & controlli */
const qInput=invQ,bInput=invB,sInput=invS,cashEl=$('cash'),movedEl=$('moved');
function wCostEcho(){ wCostPerUnitEl.textContent=euro(wCostPerUnit()); mcUnitEl.textContent=euro(mcUnit()); }
function marginCheck(){ const pNet=netP(our.p); const gm=pNet? (pNet-varCostPerUnit())/pNet*100 : 0; minMarginWarn.innerHTML= gm<(+minMarginPct.value||0)?'<span class="warn">Sotto margine</span>':'<span class="gain">OK</span>'; }
function refreshTotals(){
  wCostEcho(); marginCheck();
  chFixedEcho.textContent=euro(channelFixedPerDay()); chVarEcho.textContent=euro(channelVarPerUnit(netP(our.p))); chPctEcho.textContent=channelPctEcho();
  const be=bePostTax(); beUnits.textContent=isFinite(be.units)?be.units.toLocaleString('it-IT'):'— (margine ≤ 0)';
  advisor.textContent=`MC/u ${euro(mcUnit())} — BE ${beUnits.textContent}`;
  drawChart(); runAdvisor();
}
function showChannelPanels(){
  chOnline.style.display=channel==='online'?'block':'none';
  chPiva.style.display=channel==='piva'?'block':'none';
  chEmployee.style.display=channel==='employee'?'block':'none';
}

/* Bindings */
price.value=our.p; price.oninput=()=>{our.p=parseFloat(price.value); priceEcho.textContent=euro(our.p); refreshTotals();};
qInput.oninput=()=>{invQEcho.textContent=qInput.value; our.Q=1+parseInt(qInput.value||'0',10)*0.5; refreshTotals();};
bInput.oninput=()=>{invBEcho.textContent=bInput.value; our.B=1+parseInt(bInput.value||'0',10)*0.5; refreshTotals();};
sInput.oninput=()=>{invSEcho.textContent=sInput.value; our.S=1+parseInt(sInput.value||'0',10); refreshTotals();};
cap.oninput=()=>{cap=parseInt(cap.value,10); capVal.textContent=cap; capEcho.textContent=cap; drawChart();};
beta.oninput=()=>{beta=parseFloat(beta.value)||0.08; betaEcho.textContent=beta.toFixed(3);};
season.oninput=()=>{season=parseInt(season.value||'0',10); seasonEcho.textContent=(season>=0?'+':'')+season+'%'; drawChart();};
iva.oninput=()=>{ivaIncl=iva.checked; refreshTotals();};
ivaPct.oninput=()=>{ivaPct=parseFloat(ivaPct.value)/100; refreshTotals();};
buyCost.oninput=()=>{save('buyCost',+buyCost.value); refreshTotals();};
varOver.oninput=()=>{save('varOver',+varOver.value); refreshTotals();};
minMarginPct.oninput=()=>{save('minMarginPct',+minMarginPct.value); refreshTotals();};

/* Channel inputs */
const chOnline=$('ch-online'),chPiva=$('ch-piva'),chEmployee=$('ch-employee');
channelSel.oninput=()=>{channel=channelSel.value; save('channel',channel); showChannelPanels(); refreshTotals();};
const channelSel=$('channel');

[onFeePct,onPayPct,onFixedPer,onLogPer,onSaaS,pvAuto,pvFixed,pvPct,pvTele,pvKm,pvKml,pvFuel,emRal,emAuto,emTele,emTrips,emPct].forEach(el=>{
  if(!el)return; el.addEventListener('input',()=>{save('chParams',{
    online:{feePct:+onFeePct.value||0,payPct:+onPayPct.value||0,fixedPer:+onFixedPer.value||0,logPer:+onLogPer.value||0,saasM:+onSaaS.value||0},
    piva:{autoM:+pvAuto.value||0,fixedM:+pvFixed.value||0,pct:+pvPct.value||0,teleM:+pvTele.value||0,kmM:+pvKm.value||0,kml:+pvKml.value||1,fuel:+pvFuel.value||0},
    employee:{ralY:+emRal.value||0,autoM:+emAuto.value||0,teleM:+emTele.value||0,tripsM:+emTrips.value||0,pct:+emPct.value||0}
  }); refreshTotals();});
});

/* Compatibilità id */
const wCostPerUnitEl=$('wCostPerUnit'), mcUnitEl=$('mcUnit');

/* Pulsanti */
advance.onclick=()=>{
  // mosse competitor semplici
  comps.forEach(c=>{
    if(c.strat==='price'){const t=Math.max(12,our.p*.95);const p=c.p;c.p=clamp(c.p*.6+t*.4,10,120);pushLog(c.name,`prezzo ${euro(p)}→${euro(c.p)}`);}
    else if(c.strat==='premium'){if(Math.random()<.5)c.Q=Math.min(5,c.Q+1);else c.B=Math.min(5,c.B+1);c.p=clamp(c.p*1.01,30,140);pushLog(c.name,`mix Q/B· prezzo ${euro(c.p)}`);}
    else{const i=Math.random()<c.epsilon?Math.floor(Math.random()*c.actions.length):c.Qvals.indexOf(Math.max(...c.Qvals));const a=c.actions[i];const p=c.p; if(a.dp)c.p=clamp(c.p*(1+a.dp),10,140); if(a.dQ)c.Q=Math.min(5,c.Q+1); if(a.dB)c.B=Math.min(5,c.B+1); if(a.dS)c.S=Math.min(5,c.S+1); pushLog(c.name,`${a.name}`);}
  });
  simulateDay(); day++; dayEl.textContent=day; if(day>10){alert('Fine partita: '+cumprofit.textContent); location.reload();}
};
reset.onclick=()=>location.reload();

/* INIT: ripristina canale e valori */
(function initFromLS(){
  // canale
  channelSel.value=channel; showChannelPanels();
  // ch params
  onFeePct.value=ch.online.feePct; onPayPct.value=ch.online.payPct; onFixedPer.value=ch.online.fixedPer; onLogPer.value=ch.online.logPer; onSaaS.value=ch.online.saasM;
  pvAuto.value=ch.piva.autoM; pvFixed.value=ch.piva.fixedM; pvPct.value=ch.piva.pct; pvTele.value=ch.piva.teleM; pvKm.value=ch.piva.kmM; pvKml.value=ch.piva.kml; pvFuel.value=ch.piva.fuel;
  emRal.value=ch.employee.ralY; emAuto.value=ch.employee.autoM; emTele.value=ch.employee.teleM; emTrips.value=ch.employee.tripsM; emPct.value=ch.employee.pct;
  priceEcho.textContent=euro(our.p); capVal.textContent=cap; capEcho.textContent=cap; cash.textContent=euro(cash);
  renderTable(); refreshTotals(); drawChart();
})();
</script>
</body>
</html>
